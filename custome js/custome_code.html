


 // Fetch Feeheads from the server
 fetch('../php/feeCanva/fetch_canva_feeHead.php')
 .then(response => response.json())
 .then(data => {
   const feeTypeDropdown = document.getElementById('feeType');
   feeTypeDropdown.innerHTML = '<option value="" disabled selected>Select Fee Type</option>'; // Clear default option

   // Populate options dynamically
   data.forEach(feehead => {
     const option = document.createElement('option');
     option.value = feehead.id;
     option.textContent = feehead.fee_head_name;
     feeTypeDropdown.appendChild(option);
   });
 })
 .catch(error => {
   console.error('Error fetching fee types:', error);
   const feeTypeDropdown = document.getElementById('feeType');
   feeTypeDropdown.innerHTML = '<option value="" disabled selected>Error loading fee types</option>';
 });

 // send data to table
document.addEventListener("DOMContentLoaded", function () {
  const saveFeeButton = document.getElementById("saveFeeButton");

  // Handle Save Fee Button Click
  saveFeeButton.addEventListener("click", function () {
    const feeMonth = document.getElementById("feeMonth").value;
    const feeTypeDropdown = document.getElementById('feeType');
    const feeType = feeTypeDropdown.options[feeTypeDropdown.selectedIndex]?.text || '';
    const feeAmount = document.getElementById("feeAmount").value;

    if (feeMonth && feeType && feeAmount) {
      // Reference the FeeCollection table's body
      const feeTableBody = document.querySelector("#FeeCollection tbody");

      // Create a new row
      const newRow = document.createElement("tr");

      // Add cells with the entered data
      newRow.innerHTML = `
        <td>${feeMonth}</td>
        <td>${feeType}</td>
        <td>${feeAmount}</td>
        <td>
          <button type="button" class="btn btn-danger btn-sm deleteFeeButton">
            <i class="bx bx-trash"></i>
          </button>
        </td>
      `;

      // Append the new row to the FeeCollection table
      feeTableBody.appendChild(newRow);

      // Clear the form fields in the canvas
      document.getElementById("feeForm").reset();

      // Add event listener for the delete button
      newRow.querySelector(".deleteFeeButton").addEventListener("click", function () {
        newRow.remove(); // Remove the row from the table
      });

      // Close the offcanvas (if desired)
      const addFeeCanvas = bootstrap.Offcanvas.getInstance(document.getElementById("addFeeCanvas"));
      if (addFeeCanvas) {
        addFeeCanvas.hide();
      }
    } else {
      alert("Please fill out all fields before saving.");
    }
  });
});


 /*
// Handle Save Fee button click
document.getElementById('saveFeeButton').addEventListener('click', function (e) {
  e.preventDefault();

  // Get form values
  const feeTypeDropdown = document.getElementById('feeType');
  const feeType = feeTypeDropdown.options[feeTypeDropdown.selectedIndex]?.text || '';
  const feeAmount = document.getElementById('feeAmount').value;
  const feeMonth = document.getElementById('feeMonth').value;

  // Validate inputs
  if (!feeType || !feeAmount || !feeMonth) {
    alert('Please fill out all required fields.');
    return;
  }

  // Get FeeCollection table body
  const feeTableBody = document.querySelector('#FeeCollection tbody');

  // Create a new row
  const newRow = document.createElement('tr');
  newRow.innerHTML = `
    <td>${feeMonth}</td>
    <td>${feeType}</td>
    <td>${feeAmount}</td>
    <td>
      <button type="button" class="btn btn-danger btn-sm deleteFeeButton">
        <i class="bx bx-trash"></i>
      </button>
    </td>
  `;

  // Append new row to the table
  feeTableBody.appendChild(newRow);

  // Add delete functionality
  newRow.querySelector('.deleteFeeButton').addEventListener('click', function () {
    newRow.remove();
  });

  // Reset form
  document.getElementById('feeForm').reset();

  // Optionally close the offcanvas
  const offcanvasInstance = bootstrap.Offcanvas.getInstance(document.getElementById('addFeeCanvas'));
  if (offcanvasInstance) {
    offcanvasInstance.hide();
  }
});
*/
/******************************************************** */

document.addEventListener("DOMContentLoaded", function () {
  const feeTypeDropdown = document.getElementById("feeType");
  const saveFeeButton = document.getElementById("saveFeeButton");
  const feeForm = document.getElementById("feeForm");
  const feeTableBody = document.querySelector("#FeeCollection tbody");
  const addFeeCanvasEl = document.getElementById("addFeeCanvas");
  let isSaveButtonClicked = false; // Track if Save button was clicked

  const addFeeCanvas = bootstrap.Offcanvas.getInstance(addFeeCanvasEl) || new bootstrap.Offcanvas(addFeeCanvasEl);

  // Fetch fee heads and populate the dropdown
  const fetchFeeHeads = async () => {
    try {
      const response = await fetch("../php/feeCanva/fetch_canva_feeHead.php");
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

      const data = await response.json();

      // Populate dropdown options
      feeTypeDropdown.innerHTML = '<option value="" disabled selected>Select Fee Type</option>';
      data.forEach((feehead) => {
        const option = document.createElement("option");
        option.value = feehead.id;
        option.textContent = feehead.fee_head_name;
        feeTypeDropdown.appendChild(option);
      });
    } catch (error) {
      console.error("Error fetching fee types:", error);
      feeTypeDropdown.innerHTML = '<option value="" disabled selected>Error loading fee types</option>';
    }
  };

  // Validate form fields
  const validateForm = () => {
    const feeMonth = document.getElementById("feeMonth").value.trim();
    const feeType = feeTypeDropdown.options[feeTypeDropdown.selectedIndex]?.text || '';
    const feeAmount = document.getElementById("feeAmount").value.trim();

    if (!feeMonth) {
      return { isValid: false, message: "Please select a valid month." };
    }

    if (!feeType || feeTypeDropdown.value === "") {
      return { isValid: false, message: "Please select a fee type." };
    }

    if (!feeAmount || isNaN(feeAmount) || Number(feeAmount) <= 0) {
      return { isValid: false, message: "Please enter a valid fee amount." };
    }

    return { isValid: true, feeMonth, feeType, feeAmount };
  };

  // Add a new row to the FeeCollection table
  const addRowToTable = ({ feeMonth, feeType, feeAmount }) => {
    const newRow = document.createElement("tr");

    newRow.innerHTML = `
      <td>${feeMonth}</td>
      <td>${feeType}</td>
      <td>${feeAmount}</td>
      <td>
        <button type="button" class="btn btn-warning btn-sm editFeeButton">
          <i class="bx bx-edit"></i>
        </button>
        <button type="button" class="btn btn-danger btn-sm deleteFeeButton">
          <i class="bx bx-trash"></i>
        </button>
      </td>
    `;

    feeTableBody.appendChild(newRow);

    // Add event listener to the delete button
    const deleteButton = newRow.querySelector(".deleteFeeButton");
    deleteButton.addEventListener("click", () => newRow.remove());

    // Add event listener to the edit button
    const editButton = newRow.querySelector(".editFeeButton");
    editButton.addEventListener("click", () => handleEditFee(newRow));
  };

  // Handle Edit Fee
  const handleEditFee = (row) => {
    const feeMonthCell = row.children[0];
    const feeTypeCell = row.children[1];
    const feeAmountCell = row.children[2];

    // Show Swal with pre-filled values
    Swal.fire({
      title: "Edit Fee Details",
      html: `
        <label for="editFeeMonth" class="form-label">Fee Month</label>
        <input id="editFeeMonth" class="swal2-input" value="${feeMonthCell.textContent}">

        <label for="editFeeType" class="form-label">Fee Type</label>
        <input id="editFeeType" class="swal2-input" value="${feeTypeCell.textContent}">

        <label for="editFeeAmount" class="form-label">Fee Amount</label>
        <input id="editFeeAmount" class="swal2-input" type="number" value="${feeAmountCell.textContent}">
      `,
      confirmButtonText: "Save",
      showCancelButton: true,
      preConfirm: () => {
        const editedFeeMonth = document.getElementById("editFeeMonth").value.trim();
        const editedFeeType = document.getElementById("editFeeType").value.trim();
        const editedFeeAmount = document.getElementById("editFeeAmount").value.trim();

        if (!editedFeeMonth || !editedFeeType || !editedFeeAmount || isNaN(editedFeeAmount) || Number(editedFeeAmount) <= 0) {
          Swal.showValidationMessage("Please fill out all fields correctly.");
          return false;
        }

        return { editedFeeMonth, editedFeeType, editedFeeAmount };
      },
    }).then((result) => {
      if (result.isConfirmed) {
        const { editedFeeMonth, editedFeeType, editedFeeAmount } = result.value;

        // Update row data
        feeMonthCell.textContent = editedFeeMonth;
        feeTypeCell.textContent = editedFeeType;
        feeAmountCell.textContent = editedFeeAmount;

        Swal.fire("Updated!", "Fee details have been updated successfully.", "success");
      }
    });
  };

  // Handle Save Fee button click
  const handleSaveFee = () => {
    isSaveButtonClicked = true; // Mark save button as clicked

    const { isValid, message, ...data } = validateForm();
    if (isValid) {
      addRowToTable(data);

      // Reset the form
      feeForm.reset();

      // Close the offcanvas
      addFeeCanvas.hide();

      // Show a success alert (optional)
      Swal.fire("Success", "Fee details added successfully.", "success");
    } else {
      Swal.fire("Error", message, "error");
    }

    isSaveButtonClicked = false; // Reset after action
  };

  // Handle Offcanvas Hide Event
  addFeeCanvasEl.addEventListener("hide.bs.offcanvas", (event) => {
    if (!isSaveButtonClicked) {
      // Prevent validation alert during offcanvas hiding
      feeForm.reset();
    }
  });

  // Initialize event listeners
  const initialize = () => {
    fetchFeeHeads();
    saveFeeButton.addEventListener("click", handleSaveFee);
  };

  initialize();
});

/****************************************** */
const fetchFeeHeads = async (retryCount = 3) => {
    feeTypeDropdown.innerHTML = '<option value="" disabled selected>Loading...</option>';
    try {
      const response = await fetch("../php/feeCanva/fetch_canva_feeHead.php");
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      const data = await response.json();

      if (!Array.isArray(data) || data.length === 0) {
        throw new Error("No valid data received.");
      }

      feeTypeDropdown.innerHTML = '<option value="" disabled selected>Select Fee Type</option>';
      data.forEach((feehead) => {
        const option = document.createElement("option");
        option.value = feehead.id;
        option.textContent = feehead.fee_head_name;
        feeTypeDropdown.appendChild(option);
      });
    } catch (error) {
      console.error("Error fetching fee types:", error);
      feeTypeDropdown.innerHTML = '<option value="" disabled selected>Error loading fee types</option>';
      if (retryCount > 0) {
        await fetchFeeHeads(retryCount - 1);
      } else {
        Swal.fire("Error", "Failed to load fee types. Please try again later.", "error");
      }
    }
  };

  /****************************************** */

  document.addEventListener("DOMContentLoaded", function () {
  const feeTypeDropdown = document.getElementById("feeType");
  const saveFeeButton = document.getElementById("saveFeeButton");
  const feeForm = document.getElementById("feeForm");
  const feeTableBody = document.querySelector("#FeeCollection tbody");
  const addFeeCanvasEl = document.getElementById("addFeeCanvas");
  let isSaveButtonClicked = false;

  // Check if required elements exist
  if (!feeTypeDropdown || !saveFeeButton || !feeForm || !feeTableBody || !addFeeCanvasEl) {
    console.error("Required elements are missing from the DOM.");
    return;
  }

  // Initialize Offcanvas
  const addFeeCanvas = bootstrap.Offcanvas.getInstance(addFeeCanvasEl) || new bootstrap.Offcanvas(addFeeCanvasEl);

  // Fetch fee heads and populate the dropdown
  const fetchFeeHeads = async (retryCount = 3, delayMs = 1000) => {
    feeTypeDropdown.innerHTML = '<option value="" disabled selected>Loading...</option>';
    try {
      const response = await fetch("/php/feeCanva/fetch_canva_feeHead.php");
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

      const data = await response.json();

      // Validate response data
      if (!Array.isArray(data) || data.length === 0) {
        throw new Error("No valid data received.");
      }

      // Populate dropdown
      feeTypeDropdown.innerHTML = '<option value="" disabled selected>Select Fee Type</option>';
      data.forEach((feehead) => {
        if (feehead.fee_head_id && feehead.fee_head_name) {
          const option = document.createElement("option");
          option.value = feehead.fee_head_id;
          option.textContent = feehead.fee_head_name;
          feeTypeDropdown.appendChild(option);
        } else {
          console.warn("Skipping invalid fee head entry:", feehead);
        }
      });
    } catch (error) {
      console.error("Error fetching fee types:", error);

      // Retry logic
      if (retryCount > 0) {
        console.warn(`Retrying... Attempts left: ${retryCount}`);
        await new Promise((resolve) => setTimeout(resolve, delayMs));
        await fetchFeeHeads(retryCount - 1, delayMs);
      } else {
        feeTypeDropdown.innerHTML = '<option value="" disabled selected>Error loading fee types</option>';
        Swal.fire("Error", "Failed to load fee types after multiple attempts. Please try again later.", "error");
      }
    }
  };

  // Utility function to capitalize the first letter of each word
  const capitalize = (str) =>
    str
      .toLowerCase()
      .replace(/\b\w/g, (char) => char.toUpperCase());

  // Validate form fields
  const validateForm = () => {
    const feeMonthElement = document.getElementById("feeMonth");
    const feeAmountElement = document.getElementById("feeAmount");

    if (!feeMonthElement || !feeAmountElement) {
      return { isValid: false, message: "Required form elements are missing!" };
    }

    const feeMonth = capitalize(feeMonthElement.value.trim());
    const feeType = feeTypeDropdown.options[feeTypeDropdown.selectedIndex]?.text || '';
    const feeAmount = feeAmountElement.value.trim();

    if (!feeMonth) return { isValid: false, message: "Please select a valid month." };
    if (!feeType || feeTypeDropdown.value === "") return { isValid: false, message: "Please select a fee type." };
    if (!feeAmount || isNaN(feeAmount) || Number(feeAmount) <= 0) return { isValid: false, message: "Please enter a valid fee amount." };

    return { isValid: true, feeMonth, feeType, feeAmount };
  };

  // Handle Save Fee button click
  const handleSaveFee = () => {
    isSaveButtonClicked = true;

    const { isValid, message, ...data } = validateForm();
    if (isValid) {
      addRowToTable(data);

      feeForm.reset();
      addFeeCanvas.hide();

      Swal.fire({
        title: "Success",
        text: "Fee details added successfully.",
        icon: "success",
        timer: 2000,
        timerProgressBar: true,
        didOpen: () => Swal.showLoading(),
      });
    } else {
      Swal.fire("Error", message, "error");
    }

    isSaveButtonClicked = false;
  };

  // Add a new row to the FeeCollection table
  const addRowToTable = ({ feeMonth, feeType, feeAmount }) => {
    const newRow = document.createElement("tr");

    newRow.innerHTML = `
      <td>${feeMonth}</td>
      <td>${feeType}</td>
      <td>${feeAmount}</td>
      <td>
        <div class="d-flex gap-1">
          <button class="btn editFeeButton">
            <i class="btn-outline-warning bx bx-edit bx-sm"></i>
          </button>
          <button type="button" class="btn deleteFeeButton">
            <i class="btn-outline-danger bx bx-trash bx-sm"></i>
          </button>
        </div>
      </td>
    `;

    feeTableBody.appendChild(newRow);

    // Add Delete Button Event Listener
    newRow.querySelector(".deleteFeeButton").addEventListener("click", () => {
      Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, delete it!",
        cancelButtonText: "Cancel",
      }).then((result) => {
        if (result.isConfirmed) {
          newRow.remove();
          Swal.fire("Deleted!", "The fee record has been deleted.", "success");
        }
      });
    });

    // Add Edit Button Event Listener
    newRow.querySelector(".editFeeButton").addEventListener("click", () => handleEditFee(newRow));
  };

  // Handle Edit Fee
  const handleEditFee = (row) => {
    const feeMonthCell = row.children[0];
    const feeTypeCell = row.children[1];
    const feeAmountCell = row.children[2];

    Swal.fire({
      title: "Edit Fee Details",
      html: `
        <label for="editFeeMonth" class="form-label">Fee Month</label>
        <input id="editFeeMonth" class="swal2-input" value="${capitalize(feeMonthCell.textContent)}">

        <label for="editFeeType" class="form-label">Fee Type</label>
        <input id="editFeeType" class="swal2-input" value="${feeTypeCell.textContent}">

        <label for="editFeeAmount" class="form-label">Fee Amount</label>
        <input id="editFeeAmount" class="swal2-input" type="number" value="${feeAmountCell.textContent}">
      `,
      confirmButtonText: "Save",
      showCancelButton: true,
      preConfirm: () => {
        const editedFeeMonth = capitalize(document.getElementById("editFeeMonth").value.trim());
        const editedFeeType = document.getElementById("editFeeType").value.trim();
        const editedFeeAmount = document.getElementById("editFeeAmount").value.trim();

        if (!editedFeeMonth || !editedFeeType || !editedFeeAmount || isNaN(editedFeeAmount) || Number(editedFeeAmount) <= 0) {
          Swal.showValidationMessage("Please fill out all fields correctly.");
          return false;
        }

        return { editedFeeMonth, editedFeeType, editedFeeAmount };
      },
    }).then((result) => {
      if (result.isConfirmed) {
        const { editedFeeMonth, editedFeeType, editedFeeAmount } = result.value;

        feeMonthCell.textContent = editedFeeMonth;
        feeTypeCell.textContent = editedFeeType;
        feeAmountCell.textContent = editedFeeAmount;

        Swal.fire("Updated!", "Fee details have been updated successfully.", "success");
      }
    });
  };

  // Handle Offcanvas Hide Event
  addFeeCanvasEl.addEventListener("hide.bs.offcanvas", () => {
    if (!isSaveButtonClicked) {
      feeForm.reset();
    }
  });

  // Initialize event listeners
  const initialize = () => {
    fetchFeeHeads();
    saveFeeButton.addEventListener("click", handleSaveFee);
  };

  initialize();
});


/*balck box code*/

document.addEventListener("DOMContentLoaded", function () {
  const feeTypeDropdown = document.getElementById("feeType");
  const saveFeeButton = document.getElementById("saveFeeButton");
  const feeForm = document.getElementById("feeForm");
  const feeTableBody = document.querySelector("#FeeCollection tbody");
  const addFeeCanvasEl = document.getElementById("addFeeCanvas");
  let isSaveButtonClicked = false;

  // Check if addFeeCanvasEl exists
  if (!addFeeCanvasEl) {
    console.error('Element with ID "addFeeCanvas" not found');
    return; // Exit if the element is not found
  }

  // Initialize Offcanvas
  const addFeeCanvas = bootstrap.Offcanvas.getInstance(addFeeCanvasEl) || new bootstrap.Offcanvas(addFeeCanvasEl);

  // Fetch fee heads and populate the dropdown
  const fetchFeeHeads = async (retryCount = 3, delayMs = 1000) => {
    feeTypeDropdown.innerHTML = '<option value="" disabled selected>Loading...</option>';
    try {
      const response = await fetch("../php/feeCanva/fetch_canva_feeHead.php");
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

      const result = await response.json();
      if (result.status !== 'success' || !Array.isArray(result.data)) {
        throw new Error("Invalid response structure or no data.");
      }

      // Populate dropdown
      const feeheads = result.data;
      feeTypeDropdown.innerHTML = '<option value="" disabled selected>Select Fee Type</option>';
      feeheads.forEach(({ fee_head_id, fee_head_name }) => {
        if (fee_head_id && fee_head_name) {
          const option = document.createElement("option");
          option.value = fee_head_id;
          option.textContent = fee_head_name;
          feeTypeDropdown.appendChild(option);
        }
      });
    } catch (error) {
      console.error("Error fetching fee types:", error);
      feeTypeDropdown.innerHTML = '<option value="" disabled selected>Error loading fee types</option>';

      if (retryCount > 0) {
        console.warn(`Retrying... Attempts left: ${retryCount}`);
        await new Promise((resolve) => setTimeout(resolve, delayMs));
        await fetchFeeHeads(retryCount - 1, delayMs);
      } else {
        Swal.fire("Error", "Failed to load fee types after multiple attempts.", "error");
      }
    }
  };

  // Utility function to capitalize the first letter of each word
  const capitalize = (str) => {
    return str
      .toLowerCase()
      .replace(/\b\w/g, (char) => char.toUpperCase());
  };

  // Validate form fields
  const validateForm = () => {
    const feeMonthElement = document.getElementById("feeMonth");
    const feeAmountElement = document.getElementById("feeAmount");

    if (!feeMonthElement || !feeAmountElement) {
      console.error("Required form elements are missing!");
      return { isValid: false, message: "Form validation failed." };
    }

    const feeMonth = capitalize(feeMonthElement.value.trim());
    const feeType = feeTypeDropdown.options[feeTypeDropdown.selectedIndex]?.text || '';
    const feeAmount = feeAmountElement.value.trim();

    if (!feeMonth) {
      return { isValid: false, message: "Please select a valid month." };
    }
    if (!feeType || feeTypeDropdown.value === "") {
      return { isValid: false, message: "Please select a fee type." };
    }
    if (!feeAmount || isNaN(feeAmount) || Number(feeAmount) <= 0 ) {
      return { isValid: false, message: "Please enter a valid fee amount." };
    }

    return { isValid: true, feeMonth, feeType, feeAmount };
  };

  // Handle Save Fee button click
  const handleSaveFee = () => {
    isSaveButtonClicked = true;

    const { isValid, message, ...data } = validateForm();
    if (isValid) {
      addRowToTable(data);

      feeForm.reset();
      addFeeCanvas.hide();

      Swal.fire({
        title: "Success",
        text: "Fee details added successfully.",
        icon: "success",
        timer: 2000,
        timerProgressBar: true,
        didOpen: () => Swal.showLoading(),
      });
    } else {
      Swal.fire("Error", message, "error");
    }

    isSaveButtonClicked = false;
  };

  // Add a new row to the FeeCollection table
  const addRowToTable = ({ feeMonth, feeType, feeAmount }) => {
    const newRow = document.createElement("tr");

    newRow.innerHTML = `
      <td>${feeMonth}</td>
      <td>${feeType}</td>
      <td>${feeAmount}</td>
      <td>
        <div class="d-flex gap-1">
          <button class="btn editFeeButton" style="margin: 0 -8px;">
            <i class="btn-outline-warning bx bx-edit bx-sm"></i>
          </button>
          <button type="button" class="btn deleteFeeButton" style="margin: 0 -8px;">
            <i class="btn-outline-danger bx bx-trash bx-sm"></i>
          </button>
        </div>
      </td>
    `;

    feeTableBody.appendChild(newRow);

    // Add Delete Button Event Listener
    const deleteButton = newRow.querySelector(".deleteFeeButton");
    deleteButton.addEventListener("click", () => {
      Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, delete it!",
        cancelButtonText: "Cancel",
      }).then((result) => {
        if (result.isConfirmed) {
          newRow.remove();
          Swal.fire("Deleted!", "The fee record has been deleted.", "success");
        }
      });
    });

    // Add Edit Button Event Listener
    const editButton = newRow.querySelector(".editFeeButton");
    editButton.addEventListener("click", () => handleEditFee(newRow));
  };

  // Handle Edit Fee
  const handleEditFee = (row) => {
    const feeMonthCell = row.children[0];
    const feeTypeCell = row.children[1];
    const feeAmountCell = row.children[2];

    Swal.fire({
      title: "Edit Fee Details",
      html: `
        <label for="editFeeMonth" class="form-label">Fee Month</label>
        <input id="editFeeMonth" class="swal2-input" value="${capitalize(feeMonthCell.textContent)}">

        <label for="editFeeType" class="form-label">Fee Type</label>
        <select id="editFeeType" class="swal2-select">${feeTypeDropdown.innerHTML}</select>

        <label for="editFeeAmount" class="form-label">Fee Amount</label>
        <input id="editFeeAmount" class="swal2-input" type="number" value="${feeAmountCell.textContent}">
      `,
      confirmButtonText: "Save",
      showCancelButton: true,
      preConfirm: () => {
        const editedFeeMonth = capitalize(document.getElementById("editFeeMonth").value.trim());
        const editedFeeType = document.getElementById("editFeeType").options[document.getElementById("editFeeType").selectedIndex].text;
        const editedFeeAmount = document.getElementById("editFeeAmount").value.trim();

        if (!editedFeeMonth || !editedFeeType || !editedFeeAmount || isNaN(editedFeeAmount) || Number(editedFeeAmount) <= 0) {
          Swal.showValidationMessage("Please fill out all fields correctly.");
          return false;
        }

        return { editedFeeMonth, editedFeeType, editedFeeAmount };
      },
    }).then((result) => {
      if (result.isConfirmed) {
        const { editedFeeMonth, editedFeeType, editedFeeAmount } = result.value;
        feeMonthCell.textContent = editedFeeMonth;
        feeTypeCell.textContent = editedFeeType;
        feeAmountCell.textContent = editedFeeAmount;

        Swal.fire("Updated!", "Fee details have been updated successfully.", "success");
      }
    });
  };

  // Handle Offcanvas Hide Event
  addFeeCanvasEl.addEventListener("hide.bs.offcanvas", (event) => {
    if (!isSaveButtonClicked) {
      feeForm.reset();
    }
  });

  // Initialize event listeners
  const initialize = () => {
    fetchFeeHeads();
    saveFeeButton.addEventListener("click", handleSaveFee);
  };

  initialize();
});
/*
```javascript
const fetchFeeHeads = async (retryCount = 3, delayMs = 1000) => {
  feeTypeDropdown.innerHTML = '<option value="" disabled selected>Loading...</option>';
  // Show loading spinner
  const loadingSpinner = document.createElement('div');
  loadingSpinner.className = 'spinner-border';
  loadingSpinner.setAttribute('role', 'status');
  feeTypeDropdown.parentNode.insertBefore(loadingSpinner, feeTypeDropdown);

  try {
    const response = await fetch("../php/feeCanva/fetch_canva_feeHead.php");
    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

    const result = await response.json();
    if (result.status !== 'success' || !Array.isArray(result.data)) {
      throw new Error("Invalid response structure or no data.");
    }

    // Populate dropdown
    const feeheads = result.data;
    feeTypeDropdown.innerHTML = '<option value="" disabled selected>Select Fee Type</option>';
    feeheads.forEach(({ fee_head_id, fee_head_name }) => {
      if (fee_head_id && fee_head_name) {
        const option = document.createElement("option");
        option.value = fee_head_id;
        option.textContent = fee_head_name;
        feeTypeDropdown.appendChild(option);
      }
    });
  } catch (error) {
    console.error("Error fetching fee types:", error);
    feeTypeDropdown.innerHTML = '<option value="" disabled selected>Error loading fee types</option>';
  } finally {
    // Remove loading spinner
    loadingSpinner.remove();
  }
};
/* html canva*/
/*
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Offcanvas Example</title>
</head>
<body>

    <!-- Button to trigger Offcanvas -->
    <button class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#addFeeCanvas" aria-controls="addFeeCanvas">
        Add Fee
    </button>

    <!-- Offcanvas Component -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="addFeeCanvas" aria-labelledby="addFeeCanvasLabel">
        <div class="offcanvas-header">
            <h5 id="addFeeCanvasLabel" class="offcanvas-title border-bottom">Add Fee</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <!-- Your form elements go here -->
            <form id="feeForm">
                <div class="mb-3">
                    <label for="feeType" class="form-label">Fee Type</label>
                    <select id="feeType" class="form-select">
                        <option value="" disabled selected>Select Fee Type</option>
                        <!-- Options will be populated here -->
                    </select>
                </div>
                <div class="mb-3">
                    <label for="feeMonth" class="form-label">Fee Month</label>
                    <input type="text" id="feeMonth" class="form-control" placeholder="Enter Fee Month">
                </div>
                <div class="mb-3">
                    <label for="feeAmount" class="form-label">Fee Amount</label>
                    <input type="number" id="feeAmount" class="form-control" placeholder="Enter Fee Amount">
                </div>
                <button type="button" id="saveFeeButton" class="btn btn-primary">Save Fee</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const feeTypeDropdown = document.getElementById("feeType");
            const saveFeeButton = document.getElementById("saveFeeButton");
            const feeForm = document.getElementById("feeForm");
            const feeTableBody = document.querySelector("#FeeCollection tbody");
            const addFeeCanvasEl = document.getElementById("addFeeCanvas");
            let isSaveButtonClicked = false;

            if (!addFeeCanvasEl) {
                console.error('Element with ID "addFeeCanvas" not found');
                return;
            }

            const addFeeCanvas = bootstrap.Offcanvas.getInstance(addFeeCanvasEl) || new bootstrap.Offcanvas(addFeeCanvasEl);

            // Fetch fee heads and populate the dropdown
            const fetchFeeHeads = async (retryCount = 3, delayMs = 1000) => {
                feeTypeDropdown.innerHTML = '<option value="" disabled selected>Loading...</option>';
                try {
                    const response = await fetch("../php/feeCanva/fetch_canva_feeHead.php");
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                    const result = await response.json();
                    if (result.status !== 'success' || !Array.isArray(result.data)) {
                        throw new Error("Invalid response structure or no data.");
                    }

                    const feeheads = result.data;
                    feeTypeDropdown.innerHTML = '<option value="" disabled selected>Select Fee Type</option>';
                    feeheads.forEach(({ fee_head_id, fee_head_name }) => {
                        if (fee_head_id && fee_head_name) {
                            const option = document.createElement("option");
                            option.value = fee_head_id;
                            option.textContent = fee_head_name;
                            feeTypeDropdown.appendChild(option);
                        }
                    });
                } catch (error) {
                    console.error("Error fetching fee types:", error);
                    feeTypeDropdown.innerHTML = '<option value="" disabled selected>Error loading fee types</option>';
                }
            };

            // Initialize event listeners
            const initialize = () => {
                fetchFeeHeads();
                saveFeeButton.addEventListener("click", handleSaveFee);
            };

            initialize();
        });
    </script>
</body>
</html>*/


/*
Fee table selection fee design

function addToFeeCollection(month, feeType, amount) {
  const tableBody = document.querySelector('#FeeCollection tbody');
  const newRow = document.createElement('tr');

  newRow.innerHTML = `
    <td>${month}</td>
    <td>${feeType}</td>
    <td>${amount}</td>
    <td class="text-center">
      <button class="btn text-muted h-px-30" type="button" id="deleteButton">
        <i class="btn-outline-danger bx bx-trash bx-sm"></i>
      </button>
    </td>
  `;

  tableBody.appendChild(newRow);

  // Update total amount
    totalAmount += parseFloat(amount); // Add the new amount to the total
    document.querySelector('#payableAmount').value = totalAmount.toFixed(2); // Update the input field

}
*/



<!---- collect fee js  -->

document.addEventListener('DOMContentLoaded', function () {
  // Fetch and populate student data on page load
  fetchFeeData();

  // Handle "Collect Fee" button click
  document.getElementById('collect_fee_btn').addEventListener('click', collectFeeData);
});

/**
 * Fetch student and fee data from the server and populate the UI.
 */
async function fetchFeeData() {
  const loadingBar = document.getElementById('loading-bar'); // Loading bar element
  const tableBody = document.querySelector('#student_data tbody'); // Student data table body
  const feeTableBody = document.querySelector('#optms tbody'); // Fee data table body

  // Show loading bar if present
  if (loadingBar) loadingBar.style.display = 'block';

  try {
    // Fetch student and fee data from the server
    const response = await fetch('../php/collectFeeStudentDetails/students_fee_details.php');

    // Check if the response is okay
    if (!response.ok) {
      throw new Error(`Error fetching data: ${response.status}`);
    }

    const data = await response.json();

    // Validate the data
    if (!data || !data.student || !data.fee) {
      renderNoDataMessage(tableBody, feeTableBody);
      return;
    }

    // Render student data
    renderStudentData(tableBody, data.student);

    // Render fee data
    renderFeeData(data.fee);

  } catch (error) {
    console.error('Error fetching data:', error);

  } finally {
    // Hide loading bar
    if (loadingBar) loadingBar.style.display = 'none';
  }
}

/**
 * Render fee details into the cards and fee table.
 * @param {Object} feeData - Fee data object.
 */
function renderFeeData(feeData) {
  // Update fee cards
  document.getElementById('total_paid_amount').textContent = `₹ ${feeData.totalPaid || 0}`;
  document.getElementById('pending_amount').textContent = `₹ ${feeData.pendingAmount || 0}`;
  document.getElementById('hostel_amount').textContent = `₹ ${feeData.hostelAmount || 0}`;
  document.getElementById('transport_amount').textContent = `₹ ${feeData.transportAmount || 0}`;

  // Update fee table
  const feeTableBody = document.querySelector('#optms tbody');
  feeTableBody.innerHTML = ''; // Clear existing rows

  if (Array.isArray(feeData.details) && feeData.details.length > 0) {
    feeData.details.forEach(fee => {
      const row = `
        <tr>
          <td>${fee.receiptId || 'N/A'}</td>
          <td>${fee.month || 'N/A'}</td>
          <td align="center">${fee.dueAmount || '0'}</td>
          <td align="center">${fee.pendingAmount || '0'}</td>
          <td align="center">${fee.receivedAmount || '0'}</td>
          <td align="center">${fee.totalAmount || '0'}</td>
          <td>
            <span class="badge ${fee.status === 'Paid' ? 'bg-label-success' : 'bg-label-danger'}">
              ${fee.status || 'N/A'}
            </span>
          </td>
          <td align="center">
            <div class="dropdown">
              <button class="btn text-muted p-0" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bx bx-dots-vertical-rounded bx-sm"></i>
              </button>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <li><a class="dropdown-item border-bottom" href="#">View Fee Receipt</a></li>
                <li><a class="dropdown-item border-bottom" href="#">Send Fee Receipt</a></li>
                <li><a class="dropdown-item border-bottom" href="#">Send Fee Message</a></li>
                <li><a class="dropdown-item" href="#">Delete</a></li>
              </ul>
            </div>
          </td>
        </tr>
      `;
      feeTableBody.insertAdjacentHTML('beforeend', row);
    });
  } else {
    feeTableBody.innerHTML = '<tr><td colspan="8">No fee data available</td></tr>';
  }
}

/**
 * Render a message when no data is available.
 * @param {HTMLElement} studentTableBody - The student table body element.
 * @param {HTMLElement} feeTableBody - The fee table body element.
 */
function renderNoDataMessage(studentTableBody, feeTableBody) {
  studentTableBody.innerHTML = '<tr><td colspan="6">No student data available</td></tr>';
  feeTableBody.innerHTML = '<tr><td colspan="8">No fee data available</td></tr>';
}

/**
 * Render student data into the table.
 * @param {HTMLElement} tableBody - The table body element.
 * @param {Array} data - Array of student objects.
 */
function renderStudentData(tableBody, data) {
  tableBody.innerHTML = ''; // Clear existing rows

  // Generate table rows for each student
  data.forEach(student => {
    const rows = `
      <tr>
        <td class="fw-bold">Student's Name:</td>
        <td>${student.full_name || 'N/A'}</td>
        <td class="fw-bold">Father's Name:</td>
        <td>${student.father_name || 'N/A'}</td>
        <td class="fw-bold">Monthly Fee:</td>
        <td>${student.monthly_fee || 'N/A'}</td>
      </tr>
      <tr>
        <td class="fw-bold">Class:</td>
        <td>${student.class_name || 'N/A'}</td>
        <td class="fw-bold">Mother's Name:</td>
        <td>${student.mother_name || 'N/A'}</td>
        <td class="fw-bold">Type:</td>
        <td>${student.day_hosteler || 'N/A'}</td>
      </tr>
      <tr>
        <td class="fw-bold">Roll Number:</td>
        <td>${student.roll_no || 'N/A'}</td>
        <td class="fw-bold">Mobile:</td>
        <td>${student.phone || 'N/A'}</td>
        <td class="fw-bold">Gender:</td>
        <td>${student.gender || 'N/A'}</td>
      </tr>
      <tr>
        <td class="fw-bold">Hostel Fee:</td>
        <td>${student.hostel_fee || 'N/A'}</td>
        <td class="fw-bold">Transport Fee:</td>
        <td>${student.transport_fee || 'N/A'}</td>
        <td class="fw-bold">User ID:</td>
        <td>${student.user_id || 'N/A'}</td>
      </tr>`;
    tableBody.insertAdjacentHTML('beforeend', rows);
  });
}

/**
 * Collect student fee data from the table and save it in session storage.
 */
function collectFeeData() {
  const tableRows = document.querySelectorAll('#student_data tbody tr');
  const studentData = [];

  // Validate if the table contains any data
  if (tableRows.length === 0) {
    console.error('No student data available to collect.');
    return;
  }

  // Group rows in sets of 4 to represent each student's data
  for (let i = 0; i < tableRows.length; i += 4) {
    const student = {
      full_name: getCellText(tableRows[i], 2),
      father_name: getCellText(tableRows[i], 4),
      monthly_fee: getCellText(tableRows[i], 6),
      class_name: getCellText(tableRows[i + 1], 2),
      mother_name: getCellText(tableRows[i + 1], 4),
      day_hosteler: getCellText(tableRows[i + 1], 6),
      roll_no: getCellText(tableRows[i + 2], 2),
      phone: getCellText(tableRows[i + 2], 4),
      gender: getCellText(tableRows[i + 2], 6),
      hostel_fee: getCellText(tableRows[i + 3], 2),
      transport_fee: getCellText(tableRows[i + 3], 4),
      user_id: getCellText(tableRows[i + 3], 6),
    };
    studentData.push(student);
  }

  // Store data in session storage
  sessionStorage.setItem('studentData', JSON.stringify(studentData));
}

/**
 * Helper function to get text content from a specific cell in a table row.
 * @param {HTMLElement} row - The table row element.
 * @param {number} cellIndex - The index of the cell.
 * @returns {string} - The trimmed text content of the cell.
 */
function getCellText(row, cellIndex) {
  const cell = row.querySelector(`td:nth-child(${cellIndex})`);
  return cell ? cell.textContent.trim() : 'N/A';
}

/**
 * Render a message when no data is available.
 * @param {HTMLElement} tableBody - The table body element.
 */
function renderNoDataMessage(tableBody) {
  tableBody.innerHTML = '<tr><td colspan="6">No student data available</td></tr>';
}

/**
 * Render an error message in the table body.
 * @param {HTMLElement} tableBody - The table body element.
 */
function renderErrorMessage(tableBody) {
  tableBody.innerHTML = '<tr><td colspan="6">Search Student by Name or Father Name to get Details.</td></tr>';
}


<script src="/php/submitFee/get_collected_fee.php"></script>


/* Collection fee js  06-02-2025 time 8:05 pm*/
document.addEventListener('DOMContentLoaded', function () {

// Initially, ensure the loading bar is hidden by default
toggleLoadingBar(false); // This will hide the loading bar on page load

const collectFeeButton = document.getElementById('collect_fee_btn');
const tableBody = document.querySelector('#student_data tbody');

if (collectFeeButton) {
collectFeeButton.addEventListener('click', function (event) {
if (!isTableDataAvailable(tableBody)) {
event.preventDefault(); // Prevent navigation
showErrorWithLoadingBar('No student data available!'); // Show error with loading bar
} else {
collectFeeData(); // Proceed with fee collection
}
});
}
});

/**
* Check if the table contains any data rows.
* @param {HTMLElement} tableBody - The table body element.
* @returns {boolean} - True if data is available, false otherwise.
*/
function isTableDataAvailable(tableBody) {
return tableBody && tableBody.querySelectorAll('tr').length > 0;
}

/**
* Show an error message alongside the loading bar.
* @param {string} message - The error message to display.
*/
function showErrorWithLoadingBar(message) {
toggleLoadingBar(true); // Show loading bar
const errorMessage = document.getElementById('error-message');
if (errorMessage) {
errorMessage.textContent = message;
errorMessage.classList.remove('invisible'); // Show error message
}

// Hide both loading bar and error message after a delay
setTimeout(() => {
toggleLoadingBar(false);
if (errorMessage) {
errorMessage.classList.add('invisible'); // Hide error message
}
}, 3000); // 3 seconds delay
}

/**
* Toggle the visibility of the loading bar.
* @param {boolean} show - Whether to show or hide the loading bar.
*/
function toggleLoadingBar(show) {
const loadingBar = document.getElementById('loading-bar');
if (loadingBar) {
loadingBar.classList.toggle('invisible', !show); // Toggle loading bar visibility
}
}

/**
* Collect student fee data from the table and save it in session storage.
*/
function collectFeeData() {
toggleLoadingBar(true); // Show loading bar while collecting data

const tableRows = document.querySelectorAll('#student_data tbody tr');
const studentData = [];

// Validate if the table contains any data
if (tableRows.length === 0) {
showErrorWithLoadingBar('No student data available to collect!');
return;
}

// Group rows in sets of 4 to represent each student's data
for (let i = 0; i < tableRows.length; i +=4) { const student={ full_name: getCellText(tableRows[i], 2), father_name:
  getCellText(tableRows[i], 4), monthly_fee: getCellText(tableRows[i], 6), class_name: getCellText(tableRows[i + 1], 2),
  mother_name: getCellText(tableRows[i + 1], 4), day_hosteler: getCellText(tableRows[i + 1], 6), roll_no:
  getCellText(tableRows[i + 2], 2), phone: getCellText(tableRows[i + 2], 4), gender: getCellText(tableRows[i + 2], 6),
  hostel_fee: getCellText(tableRows[i + 3], 2), transport_fee: getCellText(tableRows[i + 3], 4), user_id:
  getCellText(tableRows[i + 3], 6), }; studentData.push(student); } // Store data in session storage
  sessionStorage.setItem('studentData', JSON.stringify(studentData)); toggleLoadingBar(false); // Hide loading bar after
  data is collected } /** * Helper function to get text content from a specific cell in a table row. * @param
  {HTMLElement} row - The table row element. * @param {number} cellIndex - The index of the cell. * @returns {string} -
  The trimmed text content of the cell. */ function getCellText(row, cellIndex) { const
  cell=row.querySelector(`td:nth-child(${cellIndex})`); return cell ? cell.textContent.trim() : 'N/A' ; }

