


 // Fetch Feeheads from the server
 fetch('../php/feeCanva/fetch_canva_feeHead.php')
 .then(response => response.json())
 .then(data => {
   const feeTypeDropdown = document.getElementById('feeType');
   feeTypeDropdown.innerHTML = '<option value="" disabled selected>Select Fee Type</option>'; // Clear default option

   // Populate options dynamically
   data.forEach(feehead => {
     const option = document.createElement('option');
     option.value = feehead.id;
     option.textContent = feehead.fee_head_name;
     feeTypeDropdown.appendChild(option);
   });
 })
 .catch(error => {
   console.error('Error fetching fee types:', error);
   const feeTypeDropdown = document.getElementById('feeType');
   feeTypeDropdown.innerHTML = '<option value="" disabled selected>Error loading fee types</option>';
 });

 // send data to table
document.addEventListener("DOMContentLoaded", function () {
  const saveFeeButton = document.getElementById("saveFeeButton");

  // Handle Save Fee Button Click
  saveFeeButton.addEventListener("click", function () {
    const feeMonth = document.getElementById("feeMonth").value;
    const feeTypeDropdown = document.getElementById('feeType');
    const feeType = feeTypeDropdown.options[feeTypeDropdown.selectedIndex]?.text || '';
    const feeAmount = document.getElementById("feeAmount").value;

    if (feeMonth && feeType && feeAmount) {
      // Reference the FeeCollection table's body
      const feeTableBody = document.querySelector("#FeeCollection tbody");

      // Create a new row
      const newRow = document.createElement("tr");

      // Add cells with the entered data
      newRow.innerHTML = `
        <td>${feeMonth}</td>
        <td>${feeType}</td>
        <td>${feeAmount}</td>
        <td>
          <button type="button" class="btn btn-danger btn-sm deleteFeeButton">
            <i class="bx bx-trash"></i>
          </button>
        </td>
      `;

      // Append the new row to the FeeCollection table
      feeTableBody.appendChild(newRow);

      // Clear the form fields in the canvas
      document.getElementById("feeForm").reset();

      // Add event listener for the delete button
      newRow.querySelector(".deleteFeeButton").addEventListener("click", function () {
        newRow.remove(); // Remove the row from the table
      });

      // Close the offcanvas (if desired)
      const addFeeCanvas = bootstrap.Offcanvas.getInstance(document.getElementById("addFeeCanvas"));
      if (addFeeCanvas) {
        addFeeCanvas.hide();
      }
    } else {
      alert("Please fill out all fields before saving.");
    }
  });
});


 /*
// Handle Save Fee button click
document.getElementById('saveFeeButton').addEventListener('click', function (e) {
  e.preventDefault();

  // Get form values
  const feeTypeDropdown = document.getElementById('feeType');
  const feeType = feeTypeDropdown.options[feeTypeDropdown.selectedIndex]?.text || '';
  const feeAmount = document.getElementById('feeAmount').value;
  const feeMonth = document.getElementById('feeMonth').value;

  // Validate inputs
  if (!feeType || !feeAmount || !feeMonth) {
    alert('Please fill out all required fields.');
    return;
  }

  // Get FeeCollection table body
  const feeTableBody = document.querySelector('#FeeCollection tbody');

  // Create a new row
  const newRow = document.createElement('tr');
  newRow.innerHTML = `
    <td>${feeMonth}</td>
    <td>${feeType}</td>
    <td>${feeAmount}</td>
    <td>
      <button type="button" class="btn btn-danger btn-sm deleteFeeButton">
        <i class="bx bx-trash"></i>
      </button>
    </td>
  `;

  // Append new row to the table
  feeTableBody.appendChild(newRow);

  // Add delete functionality
  newRow.querySelector('.deleteFeeButton').addEventListener('click', function () {
    newRow.remove();
  });

  // Reset form
  document.getElementById('feeForm').reset();

  // Optionally close the offcanvas
  const offcanvasInstance = bootstrap.Offcanvas.getInstance(document.getElementById('addFeeCanvas'));
  if (offcanvasInstance) {
    offcanvasInstance.hide();
  }
});
*/
/******************************************************** */

document.addEventListener("DOMContentLoaded", function () {
  const feeTypeDropdown = document.getElementById("feeType");
  const saveFeeButton = document.getElementById("saveFeeButton");
  const feeForm = document.getElementById("feeForm");
  const feeTableBody = document.querySelector("#FeeCollection tbody");
  const addFeeCanvasEl = document.getElementById("addFeeCanvas");
  let isSaveButtonClicked = false; // Track if Save button was clicked

  const addFeeCanvas = bootstrap.Offcanvas.getInstance(addFeeCanvasEl) || new bootstrap.Offcanvas(addFeeCanvasEl);

  // Fetch fee heads and populate the dropdown
  const fetchFeeHeads = async () => {
    try {
      const response = await fetch("../php/feeCanva/fetch_canva_feeHead.php");
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

      const data = await response.json();

      // Populate dropdown options
      feeTypeDropdown.innerHTML = '<option value="" disabled selected>Select Fee Type</option>';
      data.forEach((feehead) => {
        const option = document.createElement("option");
        option.value = feehead.id;
        option.textContent = feehead.fee_head_name;
        feeTypeDropdown.appendChild(option);
      });
    } catch (error) {
      console.error("Error fetching fee types:", error);
      feeTypeDropdown.innerHTML = '<option value="" disabled selected>Error loading fee types</option>';
    }
  };

  // Validate form fields
  const validateForm = () => {
    const feeMonth = document.getElementById("feeMonth").value.trim();
    const feeType = feeTypeDropdown.options[feeTypeDropdown.selectedIndex]?.text || '';
    const feeAmount = document.getElementById("feeAmount").value.trim();

    if (!feeMonth) {
      return { isValid: false, message: "Please select a valid month." };
    }

    if (!feeType || feeTypeDropdown.value === "") {
      return { isValid: false, message: "Please select a fee type." };
    }

    if (!feeAmount || isNaN(feeAmount) || Number(feeAmount) <= 0) {
      return { isValid: false, message: "Please enter a valid fee amount." };
    }

    return { isValid: true, feeMonth, feeType, feeAmount };
  };

  // Add a new row to the FeeCollection table
  const addRowToTable = ({ feeMonth, feeType, feeAmount }) => {
    const newRow = document.createElement("tr");

    newRow.innerHTML = `
      <td>${feeMonth}</td>
      <td>${feeType}</td>
      <td>${feeAmount}</td>
      <td>
        <button type="button" class="btn btn-warning btn-sm editFeeButton">
          <i class="bx bx-edit"></i>
        </button>
        <button type="button" class="btn btn-danger btn-sm deleteFeeButton">
          <i class="bx bx-trash"></i>
        </button>
      </td>
    `;

    feeTableBody.appendChild(newRow);

    // Add event listener to the delete button
    const deleteButton = newRow.querySelector(".deleteFeeButton");
    deleteButton.addEventListener("click", () => newRow.remove());

    // Add event listener to the edit button
    const editButton = newRow.querySelector(".editFeeButton");
    editButton.addEventListener("click", () => handleEditFee(newRow));
  };

  // Handle Edit Fee
  const handleEditFee = (row) => {
    const feeMonthCell = row.children[0];
    const feeTypeCell = row.children[1];
    const feeAmountCell = row.children[2];

    // Show Swal with pre-filled values
    Swal.fire({
      title: "Edit Fee Details",
      html: `
        <label for="editFeeMonth" class="form-label">Fee Month</label>
        <input id="editFeeMonth" class="swal2-input" value="${feeMonthCell.textContent}">

        <label for="editFeeType" class="form-label">Fee Type</label>
        <input id="editFeeType" class="swal2-input" value="${feeTypeCell.textContent}">

        <label for="editFeeAmount" class="form-label">Fee Amount</label>
        <input id="editFeeAmount" class="swal2-input" type="number" value="${feeAmountCell.textContent}">
      `,
      confirmButtonText: "Save",
      showCancelButton: true,
      preConfirm: () => {
        const editedFeeMonth = document.getElementById("editFeeMonth").value.trim();
        const editedFeeType = document.getElementById("editFeeType").value.trim();
        const editedFeeAmount = document.getElementById("editFeeAmount").value.trim();

        if (!editedFeeMonth || !editedFeeType || !editedFeeAmount || isNaN(editedFeeAmount) || Number(editedFeeAmount) <= 0) {
          Swal.showValidationMessage("Please fill out all fields correctly.");
          return false;
        }

        return { editedFeeMonth, editedFeeType, editedFeeAmount };
      },
    }).then((result) => {
      if (result.isConfirmed) {
        const { editedFeeMonth, editedFeeType, editedFeeAmount } = result.value;

        // Update row data
        feeMonthCell.textContent = editedFeeMonth;
        feeTypeCell.textContent = editedFeeType;
        feeAmountCell.textContent = editedFeeAmount;

        Swal.fire("Updated!", "Fee details have been updated successfully.", "success");
      }
    });
  };

  // Handle Save Fee button click
  const handleSaveFee = () => {
    isSaveButtonClicked = true; // Mark save button as clicked

    const { isValid, message, ...data } = validateForm();
    if (isValid) {
      addRowToTable(data);

      // Reset the form
      feeForm.reset();

      // Close the offcanvas
      addFeeCanvas.hide();

      // Show a success alert (optional)
      Swal.fire("Success", "Fee details added successfully.", "success");
    } else {
      Swal.fire("Error", message, "error");
    }

    isSaveButtonClicked = false; // Reset after action
  };

  // Handle Offcanvas Hide Event
  addFeeCanvasEl.addEventListener("hide.bs.offcanvas", (event) => {
    if (!isSaveButtonClicked) {
      // Prevent validation alert during offcanvas hiding
      feeForm.reset();
    }
  });

  // Initialize event listeners
  const initialize = () => {
    fetchFeeHeads();
    saveFeeButton.addEventListener("click", handleSaveFee);
  };

  initialize();
});

/****************************************** */
const fetchFeeHeads = async (retryCount = 3) => {
    feeTypeDropdown.innerHTML = '<option value="" disabled selected>Loading...</option>';
    try {
      const response = await fetch("../php/feeCanva/fetch_canva_feeHead.php");
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      const data = await response.json();

      if (!Array.isArray(data) || data.length === 0) {
        throw new Error("No valid data received.");
      }

      feeTypeDropdown.innerHTML = '<option value="" disabled selected>Select Fee Type</option>';
      data.forEach((feehead) => {
        const option = document.createElement("option");
        option.value = feehead.id;
        option.textContent = feehead.fee_head_name;
        feeTypeDropdown.appendChild(option);
      });
    } catch (error) {
      console.error("Error fetching fee types:", error);
      feeTypeDropdown.innerHTML = '<option value="" disabled selected>Error loading fee types</option>';
      if (retryCount > 0) {
        await fetchFeeHeads(retryCount - 1);
      } else {
        Swal.fire("Error", "Failed to load fee types. Please try again later.", "error");
      }
    }
  };

  /****************************************** */

  document.addEventListener("DOMContentLoaded", function () {
  const feeTypeDropdown = document.getElementById("feeType");
  const saveFeeButton = document.getElementById("saveFeeButton");
  const feeForm = document.getElementById("feeForm");
  const feeTableBody = document.querySelector("#FeeCollection tbody");
  const addFeeCanvasEl = document.getElementById("addFeeCanvas");
  let isSaveButtonClicked = false;

  // Check if required elements exist
  if (!feeTypeDropdown || !saveFeeButton || !feeForm || !feeTableBody || !addFeeCanvasEl) {
    console.error("Required elements are missing from the DOM.");
    return;
  }

  // Initialize Offcanvas
  const addFeeCanvas = bootstrap.Offcanvas.getInstance(addFeeCanvasEl) || new bootstrap.Offcanvas(addFeeCanvasEl);

  // Fetch fee heads and populate the dropdown
  const fetchFeeHeads = async (retryCount = 3, delayMs = 1000) => {
    feeTypeDropdown.innerHTML = '<option value="" disabled selected>Loading...</option>';
    try {
      const response = await fetch("/php/feeCanva/fetch_canva_feeHead.php");
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

      const data = await response.json();

      // Validate response data
      if (!Array.isArray(data) || data.length === 0) {
        throw new Error("No valid data received.");
      }

      // Populate dropdown
      feeTypeDropdown.innerHTML = '<option value="" disabled selected>Select Fee Type</option>';
      data.forEach((feehead) => {
        if (feehead.fee_head_id && feehead.fee_head_name) {
          const option = document.createElement("option");
          option.value = feehead.fee_head_id;
          option.textContent = feehead.fee_head_name;
          feeTypeDropdown.appendChild(option);
        } else {
          console.warn("Skipping invalid fee head entry:", feehead);
        }
      });
    } catch (error) {
      console.error("Error fetching fee types:", error);

      // Retry logic
      if (retryCount > 0) {
        console.warn(`Retrying... Attempts left: ${retryCount}`);
        await new Promise((resolve) => setTimeout(resolve, delayMs));
        await fetchFeeHeads(retryCount - 1, delayMs);
      } else {
        feeTypeDropdown.innerHTML = '<option value="" disabled selected>Error loading fee types</option>';
        Swal.fire("Error", "Failed to load fee types after multiple attempts. Please try again later.", "error");
      }
    }
  };

  // Utility function to capitalize the first letter of each word
  const capitalize = (str) =>
    str
      .toLowerCase()
      .replace(/\b\w/g, (char) => char.toUpperCase());

  // Validate form fields
  const validateForm = () => {
    const feeMonthElement = document.getElementById("feeMonth");
    const feeAmountElement = document.getElementById("feeAmount");

    if (!feeMonthElement || !feeAmountElement) {
      return { isValid: false, message: "Required form elements are missing!" };
    }

    const feeMonth = capitalize(feeMonthElement.value.trim());
    const feeType = feeTypeDropdown.options[feeTypeDropdown.selectedIndex]?.text || '';
    const feeAmount = feeAmountElement.value.trim();

    if (!feeMonth) return { isValid: false, message: "Please select a valid month." };
    if (!feeType || feeTypeDropdown.value === "") return { isValid: false, message: "Please select a fee type." };
    if (!feeAmount || isNaN(feeAmount) || Number(feeAmount) <= 0) return { isValid: false, message: "Please enter a valid fee amount." };

    return { isValid: true, feeMonth, feeType, feeAmount };
  };

  // Handle Save Fee button click
  const handleSaveFee = () => {
    isSaveButtonClicked = true;

    const { isValid, message, ...data } = validateForm();
    if (isValid) {
      addRowToTable(data);

      feeForm.reset();
      addFeeCanvas.hide();

      Swal.fire({
        title: "Success",
        text: "Fee details added successfully.",
        icon: "success",
        timer: 2000,
        timerProgressBar: true,
        didOpen: () => Swal.showLoading(),
      });
    } else {
      Swal.fire("Error", message, "error");
    }

    isSaveButtonClicked = false;
  };

  // Add a new row to the FeeCollection table
  const addRowToTable = ({ feeMonth, feeType, feeAmount }) => {
    const newRow = document.createElement("tr");

    newRow.innerHTML = `
      <td>${feeMonth}</td>
      <td>${feeType}</td>
      <td>${feeAmount}</td>
      <td>
        <div class="d-flex gap-1">
          <button class="btn editFeeButton">
            <i class="btn-outline-warning bx bx-edit bx-sm"></i>
          </button>
          <button type="button" class="btn deleteFeeButton">
            <i class="btn-outline-danger bx bx-trash bx-sm"></i>
          </button>
        </div>
      </td>
    `;

    feeTableBody.appendChild(newRow);

    // Add Delete Button Event Listener
    newRow.querySelector(".deleteFeeButton").addEventListener("click", () => {
      Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, delete it!",
        cancelButtonText: "Cancel",
      }).then((result) => {
        if (result.isConfirmed) {
          newRow.remove();
          Swal.fire("Deleted!", "The fee record has been deleted.", "success");
        }
      });
    });

    // Add Edit Button Event Listener
    newRow.querySelector(".editFeeButton").addEventListener("click", () => handleEditFee(newRow));
  };

  // Handle Edit Fee
  const handleEditFee = (row) => {
    const feeMonthCell = row.children[0];
    const feeTypeCell = row.children[1];
    const feeAmountCell = row.children[2];

    Swal.fire({
      title: "Edit Fee Details",
      html: `
        <label for="editFeeMonth" class="form-label">Fee Month</label>
        <input id="editFeeMonth" class="swal2-input" value="${capitalize(feeMonthCell.textContent)}">

        <label for="editFeeType" class="form-label">Fee Type</label>
        <input id="editFeeType" class="swal2-input" value="${feeTypeCell.textContent}">

        <label for="editFeeAmount" class="form-label">Fee Amount</label>
        <input id="editFeeAmount" class="swal2-input" type="number" value="${feeAmountCell.textContent}">
      `,
      confirmButtonText: "Save",
      showCancelButton: true,
      preConfirm: () => {
        const editedFeeMonth = capitalize(document.getElementById("editFeeMonth").value.trim());
        const editedFeeType = document.getElementById("editFeeType").value.trim();
        const editedFeeAmount = document.getElementById("editFeeAmount").value.trim();

        if (!editedFeeMonth || !editedFeeType || !editedFeeAmount || isNaN(editedFeeAmount) || Number(editedFeeAmount) <= 0) {
          Swal.showValidationMessage("Please fill out all fields correctly.");
          return false;
        }

        return { editedFeeMonth, editedFeeType, editedFeeAmount };
      },
    }).then((result) => {
      if (result.isConfirmed) {
        const { editedFeeMonth, editedFeeType, editedFeeAmount } = result.value;

        feeMonthCell.textContent = editedFeeMonth;
        feeTypeCell.textContent = editedFeeType;
        feeAmountCell.textContent = editedFeeAmount;

        Swal.fire("Updated!", "Fee details have been updated successfully.", "success");
      }
    });
  };

  // Handle Offcanvas Hide Event
  addFeeCanvasEl.addEventListener("hide.bs.offcanvas", () => {
    if (!isSaveButtonClicked) {
      feeForm.reset();
    }
  });

  // Initialize event listeners
  const initialize = () => {
    fetchFeeHeads();
    saveFeeButton.addEventListener("click", handleSaveFee);
  };

  initialize();
});


/*balck box code*/

document.addEventListener("DOMContentLoaded", function () {
  const feeTypeDropdown = document.getElementById("feeType");
  const saveFeeButton = document.getElementById("saveFeeButton");
  const feeForm = document.getElementById("feeForm");
  const feeTableBody = document.querySelector("#FeeCollection tbody");
  const addFeeCanvasEl = document.getElementById("addFeeCanvas");
  let isSaveButtonClicked = false;

  // Check if addFeeCanvasEl exists
  if (!addFeeCanvasEl) {
    console.error('Element with ID "addFeeCanvas" not found');
    return; // Exit if the element is not found
  }

  // Initialize Offcanvas
  const addFeeCanvas = bootstrap.Offcanvas.getInstance(addFeeCanvasEl) || new bootstrap.Offcanvas(addFeeCanvasEl);

  // Fetch fee heads and populate the dropdown
  const fetchFeeHeads = async (retryCount = 3, delayMs = 1000) => {
    feeTypeDropdown.innerHTML = '<option value="" disabled selected>Loading...</option>';
    try {
      const response = await fetch("../php/feeCanva/fetch_canva_feeHead.php");
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

      const result = await response.json();
      if (result.status !== 'success' || !Array.isArray(result.data)) {
        throw new Error("Invalid response structure or no data.");
      }

      // Populate dropdown
      const feeheads = result.data;
      feeTypeDropdown.innerHTML = '<option value="" disabled selected>Select Fee Type</option>';
      feeheads.forEach(({ fee_head_id, fee_head_name }) => {
        if (fee_head_id && fee_head_name) {
          const option = document.createElement("option");
          option.value = fee_head_id;
          option.textContent = fee_head_name;
          feeTypeDropdown.appendChild(option);
        }
      });
    } catch (error) {
      console.error("Error fetching fee types:", error);
      feeTypeDropdown.innerHTML = '<option value="" disabled selected>Error loading fee types</option>';

      if (retryCount > 0) {
        console.warn(`Retrying... Attempts left: ${retryCount}`);
        await new Promise((resolve) => setTimeout(resolve, delayMs));
        await fetchFeeHeads(retryCount - 1, delayMs);
      } else {
        Swal.fire("Error", "Failed to load fee types after multiple attempts.", "error");
      }
    }
  };

  // Utility function to capitalize the first letter of each word
  const capitalize = (str) => {
    return str
      .toLowerCase()
      .replace(/\b\w/g, (char) => char.toUpperCase());
  };

  // Validate form fields
  const validateForm = () => {
    const feeMonthElement = document.getElementById("feeMonth");
    const feeAmountElement = document.getElementById("feeAmount");

    if (!feeMonthElement || !feeAmountElement) {
      console.error("Required form elements are missing!");
      return { isValid: false, message: "Form validation failed." };
    }

    const feeMonth = capitalize(feeMonthElement.value.trim());
    const feeType = feeTypeDropdown.options[feeTypeDropdown.selectedIndex]?.text || '';
    const feeAmount = feeAmountElement.value.trim();

    if (!feeMonth) {
      return { isValid: false, message: "Please select a valid month." };
    }
    if (!feeType || feeTypeDropdown.value === "") {
      return { isValid: false, message: "Please select a fee type." };
    }
    if (!feeAmount || isNaN(feeAmount) || Number(feeAmount) <= 0 ) {
      return { isValid: false, message: "Please enter a valid fee amount." };
    }

    return { isValid: true, feeMonth, feeType, feeAmount };
  };

  // Handle Save Fee button click
  const handleSaveFee = () => {
    isSaveButtonClicked = true;

    const { isValid, message, ...data } = validateForm();
    if (isValid) {
      addRowToTable(data);

      feeForm.reset();
      addFeeCanvas.hide();

      Swal.fire({
        title: "Success",
        text: "Fee details added successfully.",
        icon: "success",
        timer: 2000,
        timerProgressBar: true,
        didOpen: () => Swal.showLoading(),
      });
    } else {
      Swal.fire("Error", message, "error");
    }

    isSaveButtonClicked = false;
  };

  // Add a new row to the FeeCollection table
  const addRowToTable = ({ feeMonth, feeType, feeAmount }) => {
    const newRow = document.createElement("tr");

    newRow.innerHTML = `
      <td>${feeMonth}</td>
      <td>${feeType}</td>
      <td>${feeAmount}</td>
      <td>
        <div class="d-flex gap-1">
          <button class="btn editFeeButton" style="margin: 0 -8px;">
            <i class="btn-outline-warning bx bx-edit bx-sm"></i>
          </button>
          <button type="button" class="btn deleteFeeButton" style="margin: 0 -8px;">
            <i class="btn-outline-danger bx bx-trash bx-sm"></i>
          </button>
        </div>
      </td>
    `;

    feeTableBody.appendChild(newRow);

    // Add Delete Button Event Listener
    const deleteButton = newRow.querySelector(".deleteFeeButton");
    deleteButton.addEventListener("click", () => {
      Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, delete it!",
        cancelButtonText: "Cancel",
      }).then((result) => {
        if (result.isConfirmed) {
          newRow.remove();
          Swal.fire("Deleted!", "The fee record has been deleted.", "success");
        }
      });
    });

    // Add Edit Button Event Listener
    const editButton = newRow.querySelector(".editFeeButton");
    editButton.addEventListener("click", () => handleEditFee(newRow));
  };

  // Handle Edit Fee
  const handleEditFee = (row) => {
    const feeMonthCell = row.children[0];
    const feeTypeCell = row.children[1];
    const feeAmountCell = row.children[2];

    Swal.fire({
      title: "Edit Fee Details",
      html: `
        <label for="editFeeMonth" class="form-label">Fee Month</label>
        <input id="editFeeMonth" class="swal2-input" value="${capitalize(feeMonthCell.textContent)}">

        <label for="editFeeType" class="form-label">Fee Type</label>
        <select id="editFeeType" class="swal2-select">${feeTypeDropdown.innerHTML}</select>

        <label for="editFeeAmount" class="form-label">Fee Amount</label>
        <input id="editFeeAmount" class="swal2-input" type="number" value="${feeAmountCell.textContent}">
      `,
      confirmButtonText: "Save",
      showCancelButton: true,
      preConfirm: () => {
        const editedFeeMonth = capitalize(document.getElementById("editFeeMonth").value.trim());
        const editedFeeType = document.getElementById("editFeeType").options[document.getElementById("editFeeType").selectedIndex].text;
        const editedFeeAmount = document.getElementById("editFeeAmount").value.trim();

        if (!editedFeeMonth || !editedFeeType || !editedFeeAmount || isNaN(editedFeeAmount) || Number(editedFeeAmount) <= 0) {
          Swal.showValidationMessage("Please fill out all fields correctly.");
          return false;
        }

        return { editedFeeMonth, editedFeeType, editedFeeAmount };
      },
    }).then((result) => {
      if (result.isConfirmed) {
        const { editedFeeMonth, editedFeeType, editedFeeAmount } = result.value;
        feeMonthCell.textContent = editedFeeMonth;
        feeTypeCell.textContent = editedFeeType;
        feeAmountCell.textContent = editedFeeAmount;

        Swal.fire("Updated!", "Fee details have been updated successfully.", "success");
      }
    });
  };

  // Handle Offcanvas Hide Event
  addFeeCanvasEl.addEventListener("hide.bs.offcanvas", (event) => {
    if (!isSaveButtonClicked) {
      feeForm.reset();
    }
  });

  // Initialize event listeners
  const initialize = () => {
    fetchFeeHeads();
    saveFeeButton.addEventListener("click", handleSaveFee);
  };

  initialize();
});
/*
```javascript
const fetchFeeHeads = async (retryCount = 3, delayMs = 1000) => {
  feeTypeDropdown.innerHTML = '<option value="" disabled selected>Loading...</option>';
  // Show loading spinner
  const loadingSpinner = document.createElement('div');
  loadingSpinner.className = 'spinner-border';
  loadingSpinner.setAttribute('role', 'status');
  feeTypeDropdown.parentNode.insertBefore(loadingSpinner, feeTypeDropdown);

  try {
    const response = await fetch("../php/feeCanva/fetch_canva_feeHead.php");
    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

    const result = await response.json();
    if (result.status !== 'success' || !Array.isArray(result.data)) {
      throw new Error("Invalid response structure or no data.");
    }

    // Populate dropdown
    const feeheads = result.data;
    feeTypeDropdown.innerHTML = '<option value="" disabled selected>Select Fee Type</option>';
    feeheads.forEach(({ fee_head_id, fee_head_name }) => {
      if (fee_head_id && fee_head_name) {
        const option = document.createElement("option");
        option.value = fee_head_id;
        option.textContent = fee_head_name;
        feeTypeDropdown.appendChild(option);
      }
    });
  } catch (error) {
    console.error("Error fetching fee types:", error);
    feeTypeDropdown.innerHTML = '<option value="" disabled selected>Error loading fee types</option>';
  } finally {
    // Remove loading spinner
    loadingSpinner.remove();
  }
};
/* html canva*/
/*
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Offcanvas Example</title>
</head>
<body>

    <!-- Button to trigger Offcanvas -->
    <button class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#addFeeCanvas" aria-controls="addFeeCanvas">
        Add Fee
    </button>

    <!-- Offcanvas Component -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="addFeeCanvas" aria-labelledby="addFeeCanvasLabel">
        <div class="offcanvas-header">
            <h5 id="addFeeCanvasLabel" class="offcanvas-title border-bottom">Add Fee</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <!-- Your form elements go here -->
            <form id="feeForm">
                <div class="mb-3">
                    <label for="feeType" class="form-label">Fee Type</label>
                    <select id="feeType" class="form-select">
                        <option value="" disabled selected>Select Fee Type</option>
                        <!-- Options will be populated here -->
                    </select>
                </div>
                <div class="mb-3">
                    <label for="feeMonth" class="form-label">Fee Month</label>
                    <input type="text" id="feeMonth" class="form-control" placeholder="Enter Fee Month">
                </div>
                <div class="mb-3">
                    <label for="feeAmount" class="form-label">Fee Amount</label>
                    <input type="number" id="feeAmount" class="form-control" placeholder="Enter Fee Amount">
                </div>
                <button type="button" id="saveFeeButton" class="btn btn-primary">Save Fee</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const feeTypeDropdown = document.getElementById("feeType");
            const saveFeeButton = document.getElementById("saveFeeButton");
            const feeForm = document.getElementById("feeForm");
            const feeTableBody = document.querySelector("#FeeCollection tbody");
            const addFeeCanvasEl = document.getElementById("addFeeCanvas");
            let isSaveButtonClicked = false;

            if (!addFeeCanvasEl) {
                console.error('Element with ID "addFeeCanvas" not found');
                return;
            }

            const addFeeCanvas = bootstrap.Offcanvas.getInstance(addFeeCanvasEl) || new bootstrap.Offcanvas(addFeeCanvasEl);

            // Fetch fee heads and populate the dropdown
            const fetchFeeHeads = async (retryCount = 3, delayMs = 1000) => {
                feeTypeDropdown.innerHTML = '<option value="" disabled selected>Loading...</option>';
                try {
                    const response = await fetch("../php/feeCanva/fetch_canva_feeHead.php");
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                    const result = await response.json();
                    if (result.status !== 'success' || !Array.isArray(result.data)) {
                        throw new Error("Invalid response structure or no data.");
                    }

                    const feeheads = result.data;
                    feeTypeDropdown.innerHTML = '<option value="" disabled selected>Select Fee Type</option>';
                    feeheads.forEach(({ fee_head_id, fee_head_name }) => {
                        if (fee_head_id && fee_head_name) {
                            const option = document.createElement("option");
                            option.value = fee_head_id;
                            option.textContent = fee_head_name;
                            feeTypeDropdown.appendChild(option);
                        }
                    });
                } catch (error) {
                    console.error("Error fetching fee types:", error);
                    feeTypeDropdown.innerHTML = '<option value="" disabled selected>Error loading fee types</option>';
                }
            };

            // Initialize event listeners
            const initialize = () => {
                fetchFeeHeads();
                saveFeeButton.addEventListener("click", handleSaveFee);
            };

            initialize();
        });
    </script>
</body>
</html>*/


/*
Fee table selection fee design

function addToFeeCollection(month, feeType, amount) {
  const tableBody = document.querySelector('#FeeCollection tbody');
  const newRow = document.createElement('tr');

  newRow.innerHTML = `
    <td>${month}</td>
    <td>${feeType}</td>
    <td>${amount}</td>
    <td class="text-center">
      <button class="btn text-muted h-px-30" type="button" id="deleteButton">
        <i class="btn-outline-danger bx bx-trash bx-sm"></i>
      </button>
    </td>
  `;

  tableBody.appendChild(newRow);

  // Update total amount
    totalAmount += parseFloat(amount); // Add the new amount to the total
    document.querySelector('#payableAmount').value = totalAmount.toFixed(2); // Update the input field

}
*/



<!---- collect fee js  -->

document.addEventListener('DOMContentLoaded', function () {
  // Fetch and populate student data on page load
  fetchFeeData();

  // Handle "Collect Fee" button click
  document.getElementById('collect_fee_btn').addEventListener('click', collectFeeData);
});

/**
 * Fetch student and fee data from the server and populate the UI.
 */
async function fetchFeeData() {
  const loadingBar = document.getElementById('loading-bar'); // Loading bar element
  const tableBody = document.querySelector('#student_data tbody'); // Student data table body
  const feeTableBody = document.querySelector('#optms tbody'); // Fee data table body

  // Show loading bar if present
  if (loadingBar) loadingBar.style.display = 'block';

  try {
    // Fetch student and fee data from the server
    const response = await fetch('../php/collectFeeStudentDetails/students_fee_details.php');

    // Check if the response is okay
    if (!response.ok) {
      throw new Error(`Error fetching data: ${response.status}`);
    }

    const data = await response.json();

    // Validate the data
    if (!data || !data.student || !data.fee) {
      renderNoDataMessage(tableBody, feeTableBody);
      return;
    }

    // Render student data
    renderStudentData(tableBody, data.student);

    // Render fee data
    renderFeeData(data.fee);

  } catch (error) {
    console.error('Error fetching data:', error);

  } finally {
    // Hide loading bar
    if (loadingBar) loadingBar.style.display = 'none';
  }
}

/**
 * Render fee details into the cards and fee table.
 * @param {Object} feeData - Fee data object.
 */
function renderFeeData(feeData) {
  // Update fee cards
  document.getElementById('total_paid_amount').textContent = `₹ ${feeData.totalPaid || 0}`;
  document.getElementById('pending_amount').textContent = `₹ ${feeData.pendingAmount || 0}`;
  document.getElementById('hostel_amount').textContent = `₹ ${feeData.hostelAmount || 0}`;
  document.getElementById('transport_amount').textContent = `₹ ${feeData.transportAmount || 0}`;

  // Update fee table
  const feeTableBody = document.querySelector('#optms tbody');
  feeTableBody.innerHTML = ''; // Clear existing rows

  if (Array.isArray(feeData.details) && feeData.details.length > 0) {
    feeData.details.forEach(fee => {
      const row = `
        <tr>
          <td>${fee.receiptId || 'N/A'}</td>
          <td>${fee.month || 'N/A'}</td>
          <td align="center">${fee.dueAmount || '0'}</td>
          <td align="center">${fee.pendingAmount || '0'}</td>
          <td align="center">${fee.receivedAmount || '0'}</td>
          <td align="center">${fee.totalAmount || '0'}</td>
          <td>
            <span class="badge ${fee.status === 'Paid' ? 'bg-label-success' : 'bg-label-danger'}">
              ${fee.status || 'N/A'}
            </span>
          </td>
          <td align="center">
            <div class="dropdown">
              <button class="btn text-muted p-0" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bx bx-dots-vertical-rounded bx-sm"></i>
              </button>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <li><a class="dropdown-item border-bottom" href="#">View Fee Receipt</a></li>
                <li><a class="dropdown-item border-bottom" href="#">Send Fee Receipt</a></li>
                <li><a class="dropdown-item border-bottom" href="#">Send Fee Message</a></li>
                <li><a class="dropdown-item" href="#">Delete</a></li>
              </ul>
            </div>
          </td>
        </tr>
      `;
      feeTableBody.insertAdjacentHTML('beforeend', row);
    });
  } else {
    feeTableBody.innerHTML = '<tr><td colspan="8">No fee data available</td></tr>';
  }
}

/**
 * Render a message when no data is available.
 * @param {HTMLElement} studentTableBody - The student table body element.
 * @param {HTMLElement} feeTableBody - The fee table body element.
 */
function renderNoDataMessage(studentTableBody, feeTableBody) {
  studentTableBody.innerHTML = '<tr><td colspan="6">No student data available</td></tr>';
  feeTableBody.innerHTML = '<tr><td colspan="8">No fee data available</td></tr>';
}

/**
 * Render student data into the table.
 * @param {HTMLElement} tableBody - The table body element.
 * @param {Array} data - Array of student objects.
 */
function renderStudentData(tableBody, data) {
  tableBody.innerHTML = ''; // Clear existing rows

  // Generate table rows for each student
  data.forEach(student => {
    const rows = `
      <tr>
        <td class="fw-bold">Student's Name:</td>
        <td>${student.full_name || 'N/A'}</td>
        <td class="fw-bold">Father's Name:</td>
        <td>${student.father_name || 'N/A'}</td>
        <td class="fw-bold">Monthly Fee:</td>
        <td>${student.monthly_fee || 'N/A'}</td>
      </tr>
      <tr>
        <td class="fw-bold">Class:</td>
        <td>${student.class_name || 'N/A'}</td>
        <td class="fw-bold">Mother's Name:</td>
        <td>${student.mother_name || 'N/A'}</td>
        <td class="fw-bold">Type:</td>
        <td>${student.day_hosteler || 'N/A'}</td>
      </tr>
      <tr>
        <td class="fw-bold">Roll Number:</td>
        <td>${student.roll_no || 'N/A'}</td>
        <td class="fw-bold">Mobile:</td>
        <td>${student.phone || 'N/A'}</td>
        <td class="fw-bold">Gender:</td>
        <td>${student.gender || 'N/A'}</td>
      </tr>
      <tr>
        <td class="fw-bold">Hostel Fee:</td>
        <td>${student.hostel_fee || 'N/A'}</td>
        <td class="fw-bold">Transport Fee:</td>
        <td>${student.transport_fee || 'N/A'}</td>
        <td class="fw-bold">User ID:</td>
        <td>${student.user_id || 'N/A'}</td>
      </tr>`;
    tableBody.insertAdjacentHTML('beforeend', rows);
  });
}

/**
 * Collect student fee data from the table and save it in session storage.
 */
function collectFeeData() {
  const tableRows = document.querySelectorAll('#student_data tbody tr');
  const studentData = [];

  // Validate if the table contains any data
  if (tableRows.length === 0) {
    console.error('No student data available to collect.');
    return;
  }

  // Group rows in sets of 4 to represent each student's data
  for (let i = 0; i < tableRows.length; i += 4) {
    const student = {
      full_name: getCellText(tableRows[i], 2),
      father_name: getCellText(tableRows[i], 4),
      monthly_fee: getCellText(tableRows[i], 6),
      class_name: getCellText(tableRows[i + 1], 2),
      mother_name: getCellText(tableRows[i + 1], 4),
      day_hosteler: getCellText(tableRows[i + 1], 6),
      roll_no: getCellText(tableRows[i + 2], 2),
      phone: getCellText(tableRows[i + 2], 4),
      gender: getCellText(tableRows[i + 2], 6),
      hostel_fee: getCellText(tableRows[i + 3], 2),
      transport_fee: getCellText(tableRows[i + 3], 4),
      user_id: getCellText(tableRows[i + 3], 6),
    };
    studentData.push(student);
  }

  // Store data in session storage
  sessionStorage.setItem('studentData', JSON.stringify(studentData));
}

/**
 * Helper function to get text content from a specific cell in a table row.
 * @param {HTMLElement} row - The table row element.
 * @param {number} cellIndex - The index of the cell.
 * @returns {string} - The trimmed text content of the cell.
 */
function getCellText(row, cellIndex) {
  const cell = row.querySelector(`td:nth-child(${cellIndex})`);
  return cell ? cell.textContent.trim() : 'N/A';
}

/**
 * Render a message when no data is available.
 * @param {HTMLElement} tableBody - The table body element.
 */
function renderNoDataMessage(tableBody) {
  tableBody.innerHTML = '<tr><td colspan="6">No student data available</td></tr>';
}

/**
 * Render an error message in the table body.
 * @param {HTMLElement} tableBody - The table body element.
 */
function renderErrorMessage(tableBody) {
  tableBody.innerHTML = '<tr><td colspan="6">Search Student by Name or Father Name to get Details.</td></tr>';
}


<script src="/php/submitFee/get_collected_fee.php"></script>


/* Collection fee js  06-02-2025 time 8:05 pm*/
document.addEventListener('DOMContentLoaded', function () {

// Initially, ensure the loading bar is hidden by default
toggleLoadingBar(false); // This will hide the loading bar on page load

const collectFeeButton = document.getElementById('collect_fee_btn');
const tableBody = document.querySelector('#student_data tbody');

if (collectFeeButton) {
collectFeeButton.addEventListener('click', function (event) {
if (!isTableDataAvailable(tableBody)) {
event.preventDefault(); // Prevent navigation
showErrorWithLoadingBar('No student data available!'); // Show error with loading bar
} else {
collectFeeData(); // Proceed with fee collection
}
});
}
});

/**
* Check if the table contains any data rows.
* @param {HTMLElement} tableBody - The table body element.
* @returns {boolean} - True if data is available, false otherwise.
*/
function isTableDataAvailable(tableBody) {
return tableBody && tableBody.querySelectorAll('tr').length > 0;
}

/**
* Show an error message alongside the loading bar.
* @param {string} message - The error message to display.
*/
function showErrorWithLoadingBar(message) {
toggleLoadingBar(true); // Show loading bar
const errorMessage = document.getElementById('error-message');
if (errorMessage) {
errorMessage.textContent = message;
errorMessage.classList.remove('invisible'); // Show error message
}

// Hide both loading bar and error message after a delay
setTimeout(() => {
toggleLoadingBar(false);
if (errorMessage) {
errorMessage.classList.add('invisible'); // Hide error message
}
}, 3000); // 3 seconds delay
}

/**
* Toggle the visibility of the loading bar.
* @param {boolean} show - Whether to show or hide the loading bar.
*/
function toggleLoadingBar(show) {
const loadingBar = document.getElementById('loading-bar');
if (loadingBar) {
loadingBar.classList.toggle('invisible', !show); // Toggle loading bar visibility
}
}

/**
* Collect student fee data from the table and save it in session storage.
*/
function collectFeeData() {
toggleLoadingBar(true); // Show loading bar while collecting data

const tableRows = document.querySelectorAll('#student_data tbody tr');
const studentData = [];

// Validate if the table contains any data
if (tableRows.length === 0) {
showErrorWithLoadingBar('No student data available to collect!');
return;
}

// Group rows in sets of 4 to represent each student's data
for (let i = 0; i < tableRows.length; i +=4) { const student={ full_name: getCellText(tableRows[i], 2), father_name:
  getCellText(tableRows[i], 4), monthly_fee: getCellText(tableRows[i], 6), class_name: getCellText(tableRows[i + 1], 2),
  mother_name: getCellText(tableRows[i + 1], 4), day_hosteler: getCellText(tableRows[i + 1], 6), roll_no:
  getCellText(tableRows[i + 2], 2), phone: getCellText(tableRows[i + 2], 4), gender: getCellText(tableRows[i + 2], 6),
  hostel_fee: getCellText(tableRows[i + 3], 2), transport_fee: getCellText(tableRows[i + 3], 4), user_id:
  getCellText(tableRows[i + 3], 6), }; studentData.push(student); } // Store data in session storage
  sessionStorage.setItem('studentData', JSON.stringify(studentData)); toggleLoadingBar(false); // Hide loading bar after
  data is collected } /** * Helper function to get text content from a specific cell in a table row. * @param
  {HTMLElement} row - The table row element. * @param {number} cellIndex - The index of the cell. * @returns {string} -
  The trimmed text content of the cell. */ function getCellText(row, cellIndex) { const
  cell=row.querySelector(`td:nth-child(${cellIndex})`); return cell ? cell.textContent.trim() : 'N/A' ; }



  /* Helper function to show an error message with a loading bar. */
  function showErrorWithLoadingBar(errorMessage) {
    toggleLoadingBar(true); // Show loading bar
    const errorElement = document.getElementById('error-message');
    if (errorElement) {
      errorElement.textContent = errorMessage;
      errorElement.classList.remove('invisible');
      }
      }
      /* Helper function to show a success message with a loading bar. */
      function showSuccessWithLoadingBar(successMessage) {
        toggleLoadingBar(true); // Show loading bar
        const successElement = document.getElementById('success-message');
        if (successElement) {
          successElement.textContent = successMessage;
          successElement.classList.remove('invisible');
          }
          }
          /* Helper function to toggle the loading bar. */
          function toggleLoadingBar(isLoading) {
            const loadingBarElement = document.getElementById('loading-bar');
            if (loadingBarElement) {
              if (isLoading) {
                loadingBarElement.classList.remove('invisible');
                }
                else {
                  loadingBarElement.classList.add('invisible');
                  }
                  }
                  }
                  /* Helper function to get the current date and time. */
                  function getCurrentDateTime() {
                    const date = new Date();
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hour = String(date.getHours()).padStart(2, '0');
                    const minute = String(date.getMinutes()).padStart(2, '0');
                    const second = String(date.getSeconds()).padStart(2, '0');
                    return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                    }
                    /* Helper function to get the current date. */
                    function getCurrentDate() {
                      const date = new Date();
                      const year = date.getFullYear();
                      const month = String(date.getMonth() + 1).padStart(2, '0');
                      const day = String(date.getDate()).padStart(2, '0');
                      return `${year}-${month}-${day}`;
                      }
                      /* Helper function to get the current time. */
                      function getCurrentTime() {
                        const date = new Date();
                        const hour = String(date.getHours()).padStart(2, '0');
                        const minute = String(date.getMinutes()).padStart(2, '0');
                        const second = String(date.getSeconds()).padStart(2, '0');
                        return `${hour}:${minute}:${second}`;
                        }
                        /* Helper function to get the current date and time in a specific format. */
                        function getCurrentDateTimeInFormat(format) {
                          const date = new Date();
                          const year = date.getFullYear();
                          const month = String(date.getMonth() + 1).padStart(2, '0');
                          const day = String(date.getDate()).padStart(2, '0');
                          const hour = String(date.getHours()).padStart(2, '0');
                          const minute = String(date.getMinutes()).padStart(2, '0');
                          const second = String(date.getSeconds()).padStart(2, '0');
                          return format.replace('YYYY', year).replace('MM', month).replace('DD', day
                          ).replace('HH', hour).replace('MM', minute).replace('SS', second);
                          }

/* working save code 07-02-2025 Friday */
                           $(document).on('click', '#saveUserChanges', function () {
   var $this = $(this);
   $this.prop('disabled', true).text('Saving...'); // Disable button and change text to prevent multiple clicks

   var userId = $('#userIdInput').val();
   var fullName = $('#fullNameInput').val();
   var qualification = $('#qualificationInput').val();
   var role = $('#roleSelect').val();
   var email = $('#emailInput').val();
   var phone = $('#phoneInput').val();
   var dob = $('#dobDateInput').val();
   var joiningDate = $('#joiningDateInput').val();
   var status = $('#statusSelect').val();
   var gender = $('#genderSelect').val();
   var salary = $('#salaryInput').val();
   var aadhar = $('#aadharInput').val();
   var subject = $('#subjectInput').val();
   var address = $('#userAddress').val();
   var bankName = $('#bankNameInput').val();
   var branchName = $('#branchNameInput').val();
   var accountNumber = $('#accountNumberInput').val();
   var ifscCode = $('#ifscCodeInput').val();
   var accountType = $('#accountType').val();

   // Creating data object to send
   var formData = {
     user_id: userId,
     full_name: fullName,
     qualification: qualification,
     role: role,
     email: email,
     phone: phone,
     dob: dob,
     joining_date: joiningDate,
     status: status,
     gender: gender,
     salary: salary,
     aadhar: aadhar,
     subject: subject,
     user_address: address,
     bank_name: bankName,
     branch_name: branchName,
     account_number: accountNumber,
     ifsc_code: ifscCode,
     account_type: accountType
   };

   // AJAX request to save data
   $.ajax({
     url: '/php/userRole/update_user_details.php', // Ensure the correct PHP path
     type: 'POST',
     data: formData,
     dataType: 'json',
     success: function (response) {
       if (response.success) {
         alert('User details updated successfully!');
         $('#editUserModal').modal('hide'); // Close modal

         // Find the row corresponding to the user to use this remove Using data-id on <tr> from table
         /*
         var userRow = $(`#userTable tbody tr`).filter(function () {
           return $(this).find('td:eq(1)').text().trim() == userId;
         });*/

         /*$('tr[data-id="userId"]') is a direct selection and faster than filtering through all rows.
         The first method (filter(function() { return $(this).find('td:eq(1)').text() == userId; }))
          requires checking each row manually, making it slower.
          */

         // Find the row corresponding to the user
         var userRow = $('#userTable tbody').find('tr[data-id="' + userId + '"]');

         if (userRow.length > 0) {
           // Update the table row data dynamically
           userRow.find('td:nth-child(3) h6').text(fullName);
           userRow.find('td:nth-child(4)').text(role);
           userRow.find('td:nth-child(5)').text(phone);
           userRow.find('td:nth-child(6)').text(formatDate(joiningDate));

           // Apply green highlight
           userRow.addClass('highlight-success');

           // Remove highlight after 3 seconds
           setTimeout(function () {
             userRow.addClass('fade-out');
             setTimeout(function () {
               userRow.removeClass('highlight-success fade-out'); // Remove both classes
             }, 1000); // Wait for fade-out animation before fully removing highlight
           }, 3000);
         } else {
           console.warn('Row for user ID ' + userId + ' not found!');
         }
       } else {
         alert('Failed to update user: ' + response.message);
       }
     },
     error: function () {
       alert('Error updating user. Please try again.');
     },
     complete: function () {
       $this.prop('disabled', false).text('Save Changes'); // Re-enable button
     }
   });
 });

<?php
require '../db_connection.php';

header('Content-Type: application/json');

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $user_id = $_POST['user_id'];
    $full_name = $_POST['full_name'];
    $qualification = $_POST['qualification'];
    $role = $_POST['role'];
    $email = $_POST['email'];
    $phone = $_POST['phone'];
    $dob = $_POST['dob'];
    $joining_date = $_POST['joining_date'];
    $status = $_POST['status'];
    $gender = $_POST['gender'];
    $salary = $_POST['salary'];
    $aadhar = $_POST['aadhar'];
    $subject = $_POST['subject'];
    $user_address = $_POST['user_address'];
    $bank_name = $_POST['bank_name'];
    $branch_name = $_POST['branch_name'];
    $account_number = $_POST['account_number'];
    $ifsc_code = $_POST['ifsc_code'];
    $account_type = $_POST['account_type'];

    try {
        $stmt = $pdo->prepare("UPDATE userRole SET
            fullname = ?, qualification = ?, role = ?, email = ?, phone = ?, dob = ?,
            joining_date = ?, status = ?, gender = ?, salary = ?, aadhar_card = ?,
            subject = ?, user_address = ?, bank_name = ?, branch_name = ?,
            account_number = ?, ifsc_code = ?, account_type = ? WHERE user_id = ?");

        $stmt->execute([
            $full_name, $qualification, $role, $email, $phone, $dob, $joining_date,
            $status, $gender, $salary, $aadhar, $subject, $user_address,
            $bank_name, $branch_name, $account_number, $ifsc_code, $account_type, $user_id
        ]);

        if ($stmt->rowCount() > 0) {
            echo json_encode(["success" => true]);
        } else {
            echo json_encode(["success" => false, "message" => "No changes made or invalid user ID"]);
        }
    } catch (PDOException $e) {
        echo json_encode(["success" => false, "message" => "Database error: " . $e->getMessage()]);
    }
} else {
    echo json_encode(["success" => false, "message" => "Invalid request"]);
}
?>

/* manage user js date on 19-02-2025 time 4.09pm*/

$(function () {
// Initialize DataTable
var table = $('#userTable').DataTable({
dom: '<"row"<"col-md-6"l><"col-md-6"B>>' + 't' + '<"row"<"col-md-6"i><"col-md-6"p>>',

        lengthMenu: [
        [5, 10, 15, 25, 50, -1],
        [5, 10, 15, 25, 50, 'All']
        ],
        pagingType: 'full_numbers',
        responsive: true,
        ordering: false, // Disable sorting for all columns
        pageLength: 10,
        language: {
        paginate: {
        first: '<<', last: '>>' , next: '>' , previous: '<' }, lengthMenu: 'Display _MENU_ records per page' ,
          info: 'Showing _START_ to _END_ of _TOTAL_ entries' , zeroRecords: 'No matching records found' ,
          infoEmpty: 'No entries to display' , infoFiltered: '(filtered from _MAX_ total entries)' }, infoCallback:
          function (settings, start, end, max, total, pre) { // Custom info text with further tweaks let
          displayLength=settings._iDisplayLength===-1 ? total : settings._iDisplayLength; return `Showing ${start} to
          ${end} of ${total} entries (Selected ${displayLength} records per page)`; }, drawCallback: function () { //
          Add custom actions when the table is redrawn // console.log('Table redrawn with current settings'); } }); //
          Function to format date function formatDate(dateString) { if (!dateString || dateString==='0000-00-00' )
          return 'N/A' ; // Handle empty and invalid dates let date=new Date(dateString); if (isNaN(date.getTime()))
          return 'N/A' ; // Ensure the date is valid let day=String(date.getDate()).padStart(2, '0' ); let
          month=String(date.getMonth() + 1).padStart(2, '0' ); // Months are 0-based let year=date.getFullYear(); return
          `${day}-${month}-${year}`; } // Fetch user data using AJAX $.ajax({ url: '../php/userRole/get_user_role.php' ,
          // The PHP file where user data is fetched type: 'GET' , dataType: 'json' , success: function (response) { //
          Check if data exists if (response && response.length> 0) {
          // var tableBody = $('#userTable tbody');
          // tableBody.empty(); // Clear any existing rows

          var table = $('#userTable').DataTable(); // Get the DataTable instance
          table.clear().draw(); // Clear existing table data

          // Loop through each user and append rows to the table
          response.forEach(function (user) {
          // Default avatar if not available
          var avatar = user.user_role_avatar ? user.user_role_avatar : '../assets/img/avatars/default-avatar.png';

          // Determine dropdown menu options based on user status
          var dropdownMenu = '';
          if (user.status === 'Pending') {
          dropdownMenu = `
          <a class="dropdown-item border-bottom userEdit" href="javascript:;" data-id="${user.user_id}">Edit</a>
          <a class="dropdown-item userActivate" href="javascript:;" data-id="${user.user_id}">Activate</a>
          `;
          } else if (user.status === 'Active') {
          dropdownMenu = `
          <a class="dropdown-item border-bottom userEdit" href="javascript:;" data-id="${user.user_id}">Edit</a>
          <a class="dropdown-item border-bottom userSuspend" href="javascript:;" data-id="${user.user_id}">Suspend</a>
          <a class="dropdown-item userCredential" href="javascript:;" data-id="${user.user_id}">Send Credential</a>
          `;
          } else if (user.status === 'Suspended') {
          dropdownMenu = `
          <a class="dropdown-item userActivate" href="javascript:;" data-id="${user.user_id}">Activate</a>
          `;
          }

          var row = `
          <tr data-id="${user.user_id}">
            <td><input type="checkbox" class="row-select"></td>
            <td>${user.user_id}</td>
            <td>
              <div class="d-flex align-items-center">
                <div class="avatar avatar-sm">
                  <img src="${avatar}" alt="avatar" class="rounded-circle" />
                </div>
                <div class="ms-2">
                  <h6 class="mb-0 ms-2">${user.fullname}</h6>
                </div>
              </div>
            </td>
            <td>${user.role}</td>
            <td>${user.phone}</td>
            <td>${formatDate(user.joining_date)}</td> <!-- ✅ Formatted Date -->
            <td><span class="badge ${
                user.status === 'Active'
                  ? 'bg-label-success'
                  : user.status === 'Suspended'
                  ? 'bg-label-secondary'
                  : 'bg-label-warning'
              }">${user.status}</span></td>
            <td>
              <a href="javascript:;" class="tf-icons bx bx-show bx-sm me-2 text-info userView" id="userView" data-id="${
                  user.user_id
                }" title="View User"></a>
              <a href="javascript:;" class="tf-icons bx bx-trash bx-sm me-2 text-danger userDelete" id="userDelete"
                data-id="${
                  user.user_id
                }" title="Delete User"></a>
              <a href="javascript:;" class="tf-icons bx bx-dots-vertical-rounded bx-sm me-2 text-warning"
                data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="More Options"></a>
              <div class="dropdown-menu dropdown-menu-end">
                ${dropdownMenu}
              </div>
            </td>
          </tr>
          `;
          // tableBody.append(row); // Add the new row to the table
          table.row.add($(row)).draw(false); // ✅ Correctly add new rows
          });

          // Reinitialize DataTable after adding rows dynamically
          // table.rows.add($('#userTable tbody tr')).draw();
          } else {
          alert('No users found!');
          }
          },
          error: function (xhr, status, error) {
          console.error('AJAX error: ' + status + ': ' + error);
          }
          });

          // Handle 'Select All' checkbox behavior
          $('#select-all').on('click', function () {
          var rows = table.rows({ search: 'applied' }).nodes();
          $('input[type="checkbox"]', rows).prop('checked', this.checked);
          });

          // Handle individual row checkbox behavior
          $('#userTable tbody').on('change', 'input[type="checkbox"]', function () {
          var rowCount = $('input[type="checkbox"]:checked').length; // Get number of selected checkboxes
          var totalRows = table.rows({ search: 'applied' }).nodes().length; // Total number of rows after search

          var selectAll = $('#select-all').get(0);
          if (rowCount === totalRows) {
          selectAll.checked = true;
          selectAll.indeterminate = false;
          } else if (rowCount === 0) {
          selectAll.checked = false;
          selectAll.indeterminate = false;
          } else {
          selectAll.indeterminate = true;
          }
          });

          // Event handler for custom length dropdown
          $('#customLength').on('change', function () {
          var length = $(this).val();
          table.page.len(length).draw();
          });

          $(document).on('change', '#avatarUpload', function (event) {
          var input = event.target;
          var file = input.files[0];

          if (file) {
          var fileType = file.type;
          var validImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];

          if (!validImageTypes.includes(fileType)) {
          Swal.fire({
          icon: 'error',
          title: 'Invalid File',
          text: 'Please select a valid image (JPEG, jpg, PNG, GIF, WEBP).'
          });
          input.value = ''; // Reset input
          return;
          }

          // File size limit (2MB)
          //if (file.size > 2 * 1024 * 1024) {
          // Swal.fire({
          // icon: 'warning',
          // title: 'File too large',
          // text: 'Maximum allowed size is 2MB.'
          // });
          // input.value = ''; // Reset input
          // return;
          //}

          var reader = new FileReader();
          reader.onload = function (e) {
          $('#userAvatar').attr('src', e.target.result);
          };

          reader.readAsDataURL(file);
          }
          });

          // Handle 'Edit' button click event
          $(document).on('click', '.userEdit', function () {
          var userId = $(this).data('id');

          $('#userAvatar').attr('src', '/assets/img/avatars/default-avatar.png');

          // Show user ID in console for debugging
          // console.log('Edit User ID:', userId);
          // Load the modal content dynamically
          $.ajax({
          url: '/html/model_user_edit/user_edit.html', // Adjust path based on your folder structure
          type: 'GET',
          success: function (data) {
          // Append the modal to the body (if not already present)
          if ($('#editUserModal').length === 0) {
          $('body').append(data);
          }

          // Set user ID in modal
          $('#editUserModal').find('#userIdInput').val(userId);

          // Show loading text inside the modal
          // $('#editUserModal .modal-body').html('<p>Loading user details...</p>');

          // Show the modal
          $('#editUserModal').modal('show');

          // Load user details using AJAX
          $.ajax({
          url: '../php/userRole/get_user_details.php', // Ensure correct path
          type: 'POST',
          data: { user_id: userId },
          dataType: 'json',
          success: function (response) {
          if (response.success) {
          var user = response.data;
          // console.log('User Data:', user); // Check if data exists

          // Populate the form with user data
          $('#userIdInput').val(user.user_id);
          $('#qualificationInput').val(user.qualification);
          $('#fullNameInput').val(user.fullname);
          $('#roleSelect').val(user.role);
          $('#emailInput').val(user.email);
          $('#phoneInput').val(user.phone);
          $('#joiningDateInput').val(user.joining_date);
          $('#statusSelect').val(user.status);
          $('#statusCauseInput').val(user.status_change_cause);
          $('#changeByInput').val(user.change_by);
          $('#salaryInput').val(user.salary);
          $('#aadharInput').val(user.aadhar_card);
          $('#subjectInput').val(user.subject);
          $('#userAddress').val(user.user_address);
          $('#genderSelect').val(user.gender);
          $('#dobDateInput').val(user.dob);
          $('#bankNameInput').val(user.bank_name);
          $('#branchNameInput').val(user.branch_name);
          $('#accountNumberInput').val(user.account_number);
          $('#ifscCodeInput').val(user.ifsc_code);
          $('#accountType').val(user.account_type);

          // Update user avatar
          $('#userAvatar').attr('src', user.user_role_avatar || '/assets/img/avatars/default-avatar.png');
          } else {
          $('#editUserModal .modal-body').html('<p class="text-danger">User not found.</p>');
          }
          },
          error: function () {
          $('#editUserModal .modal-body').html('<p class="text-danger">Error fetching data. Please try again.</p>');
          }
          });
          },
          error: function () {
          alert('Failed to load the edit modal.');
          }
          });
          });

          // Save user role update

          $(document).on('click', '#saveUserChanges', function () {
          var $this = $(this);
          if ($this.prop('disabled')) return; // Prevent multiple clicks

          $this
          .html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...')
          .prop('disabled', true);

          // Collect form data
          var formData = new FormData();
          var userId = $('#userIdInput').val();
          var fullName = $('#fullNameInput').val();
          var role = $('#roleSelect').val();
          var phone = $('#phoneInput').val();
          var joiningDate = formatDate($('#joiningDateInput').val());
          var avatarFile = $('#avatarUpload')[0].files[0];

          formData.append('user_id', userId);
          formData.append('full_name', $('#fullNameInput').val());
          formData.append('qualification', $('#qualificationInput').val());
          formData.append('role', $('#roleSelect').val());
          formData.append('email', $('#emailInput').val());
          formData.append('phone', $('#phoneInput').val());
          formData.append('dob', $('#dobDateInput').val());
          formData.append('joining_date', $('#joiningDateInput').val());
          formData.append('status', $('#statusSelect').val());
          formData.append('gender', $('#genderSelect').val());
          formData.append('salary', $('#salaryInput').val());
          formData.append('aadhar', $('#aadharInput').val());
          formData.append('subject', $('#subjectInput').val());
          formData.append('user_address', $('#userAddress').val());
          formData.append('bank_name', $('#bankNameInput').val());
          formData.append('branch_name', $('#branchNameInput').val());
          formData.append('account_number', $('#accountNumberInput').val());
          formData.append('ifsc_code', $('#ifscCodeInput').val());
          formData.append('account_type', $('#accountType').val());

          if (avatarFile) {
          formData.append('avatar', avatarFile);
          }
          // console.log([...formData.entries()]); // Check what's inside the formData
          // AJAX request to save data
          $.ajax({
          url: '/php/userRole/update_user_details.php',
          type: 'POST',
          data: formData,
          dataType: 'json',
          processData: false, // Required for file upload
          contentType: false, // Required for file upload
          success: function (response) {
          if (response.success) {
          alert('User details updated successfully!');

          // Update the user avatar preview in the modal
          if (response.avatar_path) {
          $('#userAvatar').attr('src', response.avatar_path);
          }

          // Close the modal
          $('#editUserModal').modal('hide');

          // ✅ Update the DataTable row instead of just modifying the DOM
          let table = $('#userTable').DataTable();
          let rowIndex = table
          .rows()
          .eq(0)
          .filter(rowIdx => table.cell(rowIdx, 1).data() == userId);

          if (rowIndex.length === 0) {
          console.warn('Row for user ID ' + userId + ' not found!');
          return;
          }

          // Get current row data from DataTables
          let rowData = table.row(rowIndex[0]).data();

          // ✅ Preserve avatar by extracting existing image
          let currentAvatar = $(rowData[2]).find('img').attr('src') || 'default-avatar.png';

          // ✅ Ensure avatar remains in the row
          rowData[2] = `<img src="${currentAvatar}" class="rounded-circle">
          <h6 class="mb-0">${
            rowData[2].split('</h6>')[1] || ''
          }</h6>`;

          // Update only the relevant columns
          rowData[2] = `<h6 class="mb-0">${fullName}</h6>`;
          rowData[3] = role;
          rowData[4] = phone;
          rowData[5] = joiningDate;

          // Update avatar if changed
          if (response.avatar_path) {
          rowData[2] = `<img src="${response.avatar_path}" class="avatar-img">
          <h6 class="mb-0">${fullName}</h6>`;
          }

          // ✅ Update DataTables with new data
          table.row(rowIndex[0]).data(rowData).draw(false);

          // ✅ Highlight row after edit
          let rowNode = table.row(rowIndex[0]).node();
          $(rowNode).addClass('highlight-success');

          // ✅ Remove highlight after 3 seconds
          setTimeout(() => {
          $(rowNode).addClass('fade-out');
          setTimeout(() => $(rowNode).removeClass('highlight-success fade-out'), 1000);
          }, 3000);
          } else {
          alert('Failed to update user: ' + (response.error || 'Unknown error'));
          }
          },
          error: function () {
          alert('Error updating user. Please try again.');
          },
          complete: function () {
          $this.html('Save Changes').prop('disabled', false); // Reset button
          }
          });
          });

          // Handling Status Change (Activate, Suspend)
          $(document).on('click', '.userActivate', function () {
          var userId = $(this).data('id');
          if (confirm('Are you sure you want to activate this user?')) {
          changeStatus(userId, 'Active');
          }
          });

          $(document).on('click', '.userSuspend', function () {
          var userId = $(this).data('id');
          if (confirm('Are you sure you want to suspend this user?')) {
          changeStatus(userId, 'Suspended');
          }
          });

          function showLoadingSpinner() {
          $('body').append('<div class="loading-spinner">Loading...</div>');
          }

          function hideLoadingSpinner() {
          $('.loading-spinner').remove();
          }

          /*
          function changeStatus(userId, newStatus) {
          showLoadingSpinner();
          $.ajax({
          url: '../php/userRole/update_user_status.php',
          type: 'POST',
          data: { user_id: userId, status: newStatus },
          dataType: 'json', // Ensure response is parsed as JSON
          success: function (response) {
          hideLoadingSpinner();
          console.log('Server Response:', response); // Debugging line

          if (response && response.success) {
          // Ensure response.success exists
          Swal.fire({
          icon: 'success',
          title: `User status changed to ${newStatus}`,
          toast: true,
          timer: 2000
          });

          // Find the row for the updated user

          //var row = $(`#userTable tbody tr`).filter(function () {
          // return $(this).find('td:eq(1)').text().trim() == userId;
          //});
          var row = $('#userTable').find('tr[data-id="' + userId + '"]');

          if (row.length === 0) {
          console.error('Row not found for user ID:', userId);
          return;
          }

          // Apply highlight class and ensure it sticks
          row.addClass('highlight');

          setTimeout(() => {
          row.removeClass('highlight');
          }, 5000); // Keep highlighted for 5 seconds

          // Update the status badge
          var statusBadge = row.find('td:eq(6) span');
          statusBadge.removeClass('bg-label-success bg-label-secondary bg-label-warning');

          if (newStatus === 'Active') {
          statusBadge.addClass('bg-label-success').text(newStatus);
          } else if (newStatus === 'Suspended') {
          statusBadge.addClass('bg-label-secondary').text(newStatus);
          } else if (newStatus === 'Pending') {
          statusBadge.addClass('bg-label-warning').text(newStatus);
          }

          // Update dropdown menu based on the new status
          var dropdownMenu = row.find('.dropdown-menu');
          dropdownMenu.empty(); // Clear existing options

          if (newStatus === 'Pending') {
          dropdownMenu.append(
          `
          <a class="dropdown-item border-bottom userEdit" href="javascript:;" data-id="${userId}">Edit</a>
          <a class="dropdown-item userActivate" href="javascript:;" data-id="${userId}">Activate</a>`
          );
          } else if (newStatus === 'Active') {
          dropdownMenu.append(`
          <a class="dropdown-item border-bottom userEdit" href="javascript:;" data-id="${userId}">Edit</a>
          <a class="dropdown-item border-bottom userSuspend" href="javascript:;" data-id="${userId}">Suspend</a>
          <a class="dropdown-item userCredential" href="javascript:;" data-id="${userId}">Send Credential</a>
          `);
          } else if (newStatus === 'Suspended') {
          dropdownMenu.append(
          `<a class="dropdown-item userActivate" href="javascript:;" data-id="${userId}">Activate</a>`
          );
          }
          } else {
          console.error('Response format incorrect or success=false:', response);
          Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: 'Failed to change status!',
          confirmButtonText: 'OK'
          });
          }
          },
          error: function (xhr, status, error) {
          console.error('AJAX error:', xhr.responseText);
          Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: 'Something went wrong. Please try again.',
          confirmButtonText: 'OK'
          });
          }
          });
          } */

          function changeStatus(userId, newStatus) {
          showLoadingSpinner();

          $.ajax({
          url: '../php/userRole/update_user_status.php',
          type: 'POST',
          data: { user_id: userId, status: newStatus },
          dataType: 'json',
          success: function (response) {
          hideLoadingSpinner();

          // console.log('Server Response:', response);

          if (response && response.success) {
          Swal.fire({
          icon: 'success',
          title: `User status changed to ${newStatus}`,
          toast: true,
          timer: 2000
          });

          let table = $('#userTable').DataTable();

          // Find row index in DataTable
          let rowIndex = table
          .rows()
          .eq(0)
          .filter(function (rowIdx) {
          return table.cell(rowIdx, 1).data() == userId;
          });

          if (rowIndex.length === 0) {
          console.error('Row not found for user ID:', userId);
          return;
          }

          // Get current row data
          let rowData = table.row(rowIndex[0]).data();

          // ✅ Preserve the avatar & name (Assuming it's stored in column index 2)
          let currentAvatar = rowData[2];

          // Update status badge
          let statusBadge = `<span class="status-badge badge ${
            newStatus === 'Active'
              ? 'bg-label-success'
              : newStatus === 'Suspended'
              ? 'bg-label-secondary'
              : 'bg-label-warning'
          }">${newStatus}</span>`;

          rowData[6] = statusBadge; // Assuming status column is at index 6

          // ✅ Keep the existing avatar & name
          rowData[2] = currentAvatar;

          // Update dropdown menu
          let dropdownMenu = '';
          if (newStatus === 'Pending') {
          dropdownMenu = `
          <a class="dropdown-item border-bottom userEdit" href="javascript:;" data-id="${userId}">Edit</a>
          <a class="dropdown-item userActivate" href="javascript:;" data-id="${userId}">Activate</a>`;
          } else if (newStatus === 'Active') {
          dropdownMenu = `
          <a class="dropdown-item border-bottom userEdit" href="javascript:;" data-id="${userId}">Edit</a>
          <a class="dropdown-item border-bottom userSuspend" href="javascript:;" data-id="${userId}">Suspend</a>
          <a class="dropdown-item userCredential" href="javascript:;" data-id="${userId}">Send Credential</a>`;
          } else if (newStatus === 'Suspended') {
          dropdownMenu = `<a class="dropdown-item userActivate" href="javascript:;" data-id="${userId}">Activate</a>`;
          }

          rowData[7] = `
          <a href="javascript:;" class="tf-icons bx bx-show bx-sm me-2 text-info userView" data-id="${userId}"
            title="View User"></a>
          <a href="javascript:;" class="tf-icons bx bx-trash bx-sm me-2 text-danger userDelete" data-id="${userId}"
            title="Delete User"></a>
          <a href="javascript:;" class="tf-icons bx bx-dots-vertical-rounded bx-sm text-warning"
            data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="More Options"></a>
          <div class="dropdown-menu dropdown-menu-end">${dropdownMenu}</div>
          `;

          // Update row in DataTable
          table.row(rowIndex[0]).data(rowData).draw(false);

          // Reinitialize Bootstrap dropdown (🔥 FIXES action menu issue)
          setTimeout(() => {
          $('[data-bs-toggle="dropdown"]').dropdown();
          }, 100);

          // Highlight row
          /*
          let row = $(`#userTable tbody tr[data-id="${userId}"]`);
          row.addClass('highlight');
          setTimeout(() => row.removeClass('highlight'), 5000);*/

          // ✅ Highlight row
          let rowNode = table.row(rowIndex[0]).node();
          $(rowNode).addClass('highlighted-row');

          // ✅ Remove highlight after 5 seconds
          setTimeout(() => $(rowNode).removeClass('highlighted-row'), 5000);
          } else {
          console.error('Response format incorrect or success=false:', response);
          Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: 'Failed to change status!',
          confirmButtonText: 'OK'
          });
          }
          },
          error: function (xhr, status, error) {
          console.error('AJAX error:', xhr.responseText);
          Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: 'Something went wrong. Please try again.',
          confirmButtonText: 'OK'
          });
          }
          });
          }

          // Handel 'ViewButton' click event
          $(document).on('click', '.userView', function () {
          var userId = $(this).data('id');
          alert('View user profile:' + userId);
          });



          // Handle 'Credential send' button click event
          $(document).on('click', '.userCredential', function () {
          var userId = $(this).data('id');

          // AJAX request to fetch user credentials from the server
          $.ajax({
          url: '/php/whatsapp/getUserCredentials.php', // Backend script to fetch credentials
          type: 'POST',
          data: { user_id: userId }, // Send the user ID to the backend
          dataType: 'json', // Expect JSON response
          success: function (response) {
          if (response.success) {
          var fullName = response.data.fullname;
          var password = response.data.password;
          var phone = response.data.phone;
          var fromName = response.data.fromName;

          // Display confirmation before sending credentials
          if (confirm('Send credentials to:\n' + 'Full Name: ' + fullName + '\n' + 'Phone: ' + phone)) {
          // Send credentials via WhatsApp API
          $.ajax({
          url: '/php/whatsapp/sendUserRoleCred.php', // Script to send via WhatsApp
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
          fullName: fullName,
          user_id: userId,
          password: password,
          phone: phone,
          fromName: fromName
          }),
          success: function (sendResponse) {
          console.log('Success:', sendResponse);
          alert('Credentials sent successfully!');
          },
          error: function (xhr) {
          console.error('Error:', xhr.responseText);
          alert('Failed to send credentials.');
          }
          });
          }
          } else {
          alert('User credentials not found.');
          }
          },
          error: function (xhr) {
          console.error('Error fetching credentials:', xhr.responseText);
          alert('Error retrieving user credentials.');
          }
          });
          });

          // Handle bulk action for changing status will use later
          /*
          $('#applyBulkAction').click(function () {
          var action = $('#bulkAction').val();
          var selectedUsers = [];
          $('.row-select:checked').each(function () {
          selectedUsers.push($(this).data('id'));
          });

          if (selectedUsers.length > 0 && action) {
          selectedUsers.forEach(function (userId) {
          changeStatus(userId, action);
          });
          } else {
          alert('Please select users and an action');
          }
          }); */

          // Handle Delete function
          $(document).on('click', '.userDelete', function () {
          var userId = $(this).data('id'); // Get the user ID
          var row = $(this).closest('tr'); // Get the table row containing the delete button

          // Show confirmation popup using SweetAlert2
          Swal.fire({
          title: 'You will not be able to revert this! ',
          text: 'Are you sure want to delete the user : ' + userId + '?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Yes, delete it!'
          }).then(result => {
          if (result.isConfirmed) {
          // Show Swal loading while processing
          Swal.fire({
          title: 'Deleting...',
          text: 'Please wait',
          icon: 'info',
          allowOutsideClick: false,
          showConfirmButton: false,
          didOpen: () => {
          Swal.showLoading();
          }
          });

          $.ajax({
          url: '../php/userRole/delete_user.php', // PHP script to handle deletion
          type: 'POST',
          data: { user_id: userId },
          dataType: 'json',
          success: function (response) {
          if (response.success) {
          // Show success message
          Swal.fire({
          title: 'Deleted!',
          text: 'User ' + userId + ' has been deleted.',
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
          });

          // Remove the row dynamically from DataTable
          var table = $('#userTable').DataTable();
          table.row(row).remove().draw();
          } else {
          Swal.fire('Error!', response.message, 'error');
          }
          },
          error: function (xhr, status, error) {
          console.error('AJAX Error:', status, error);
          Swal.fire('Error!', 'An error occurred while deleting.', 'error');
          }
          });
          }
          });
          });

          // Handle print button click event
          $('#printBtn').on('click', function () {
          table.button('.buttons-print').trigger(); // Trigger print when clicked
          });

          // Ensure the print button is only visible if the print button is configured
          if ($('.buttons-print').length) {
          $('#printBtn').show(); // Show the print button if it's available
          } else {
          $('#printBtn').hide(); // Hide the print button if not available
          }

          //search box
          $('#searchBox').on('keyup', function () {
          table.search(this.value).draw();
          });
          });


          /*issue is restore change data when change the <status></status>$(function () {
          // Initialize DataTable
          var table = $('#userTable').DataTable({
          dom: '<"row"<"col-md-6"l><"col-md-6"B>>' + 't' + '<"row"<"col-md-6"i><"col-md-6"p>>',

                  lengthMenu: [
                  [5, 10, 15, 25, 50, -1],
                  [5, 10, 15, 25, 50, 'All']
                  ],
                  pagingType: 'full_numbers',
                  responsive: true,
                  ordering: false, // Disable sorting for all columns
                  pageLength: 10,
                  language: {
                  paginate: {
                  first: '<<', last: '>>' , next: '>' , previous: '<' }, lengthMenu: 'Display _MENU_ records per page' ,
                    info: 'Showing _START_ to _END_ of _TOTAL_ entries' , zeroRecords: 'No matching records found' ,
                    infoEmpty: 'No entries to display' , infoFiltered: '(filtered from _MAX_ total entries)' }, infoCallback:
                    function (settings, start, end, max, total, pre) { // Custom info text with further tweaks let
                    displayLength=settings._iDisplayLength===-1 ? total : settings._iDisplayLength; return `Showing ${start} to
                    ${end} of ${total} entries (Selected ${displayLength} records per page)`; }, drawCallback: function () { //
                    Add custom actions when the table is redrawn // console.log('Table redrawn with current settings'); } }); //
                    Function to format date function formatDate(dateString) { if (!dateString || dateString==='0000-00-00' )
                    return 'N/A' ; // Handle empty and invalid dates let date=new Date(dateString); if (isNaN(date.getTime()))
                    return 'N/A' ; // Ensure the date is valid let day=String(date.getDate()).padStart(2, '0' ); let
                    month=String(date.getMonth() + 1).padStart(2, '0' ); // Months are 0-based let year=date.getFullYear(); return
                    `${day}-${month}-${year}`; } // Fetch user data using AJAX $.ajax({ url: '../php/userRole/get_user_role.php' ,
                    // The PHP file where user data is fetched type: 'GET' , dataType: 'json' , success: function (response) { //
                    Check if data exists if (response && response.length> 0) {
                    // var tableBody = $('#userTable tbody');
                    // tableBody.empty(); // Clear any existing rows

                    var table = $('#userTable').DataTable(); // Get the DataTable instance
                    table.clear().draw(); // Clear existing table data

                    // Loop through each user and append rows to the table
                    response.forEach(function (user) {
                    // Default avatar if not available
                    var avatar = user.user_role_avatar ? user.user_role_avatar : '../assets/img/avatars/default-avatar.png';

                    // Determine dropdown menu options based on user status
                    var dropdownMenu = '';
                    if (user.status === 'Pending') {
                    dropdownMenu = `
                    <a class="dropdown-item border-bottom userEdit" href="javascript:;" data-id="${user.user_id}">Edit</a>
                    <a class="dropdown-item userActivate" href="javascript:;" data-id="${user.user_id}">Activate</a>
                    `;
                    } else if (user.status === 'Active') {
                    dropdownMenu = `
                    <a class="dropdown-item border-bottom userEdit" href="javascript:;" data-id="${user.user_id}">Edit</a>
                    <a class="dropdown-item border-bottom userSuspend" href="javascript:;" data-id="${user.user_id}">Suspend</a>
                    <a class="dropdown-item userCredential" href="javascript:;" data-id="${user.user_id}">Send Credential</a>
                    `;
                    } else if (user.status === 'Suspended') {
                    dropdownMenu = `
                    <a class="dropdown-item userActivate" href="javascript:;" data-id="${user.user_id}">Activate</a>
                    `;
                    }

                    var row = `
                    <tr data-id="${user.user_id}">
                      <td><input type="checkbox" class="row-select"></td>
                      <td>${user.user_id}</td>
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="avatar avatar-sm">
                            <img src="${avatar}" alt="avatar" class="rounded-circle" />
                          </div>
                          <div class="ms-2">
                            <h6 class="mb-0 ms-2">${user.fullname}</h6>
                          </div>
                        </div>
                      </td>
                      <td>${user.role}</td>
                      <td>${user.phone}</td>
                      <td>${formatDate(user.joining_date)}</td> <!-- ✅ Formatted Date -->
                      <td><span class="badge ${
                          user.status === 'Active'
                            ? 'bg-label-success'
                            : user.status === 'Suspended'
                            ? 'bg-label-secondary'
                            : 'bg-label-warning'
                        }">${user.status}</span></td>
                      <td>
                        <a href="javascript:;" class="tf-icons bx bx-show bx-sm me-2 text-info userView" id="userView" data-id="${
                            user.user_id
                          }" title="View User"></a>
                        <a href="javascript:;" class="tf-icons bx bx-trash bx-sm me-2 text-danger userDelete" id="userDelete"
                          data-id="${
                            user.user_id
                          }" title="Delete User"></a>
                        <a href="javascript:;" class="tf-icons bx bx-dots-vertical-rounded bx-sm me-2 text-warning"
                          data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="More Options"></a>
                        <div class="dropdown-menu dropdown-menu-end">
                          ${dropdownMenu}
                        </div>
                      </td>
                    </tr>
                    `;
                    // tableBody.append(row); // Add the new row to the table
                    table.row.add($(row)).draw(false); // ✅ Correctly add new rows
                    });

                    // Reinitialize DataTable after adding rows dynamically
                    // table.rows.add($('#userTable tbody tr')).draw();
                    } else {
                    alert('No users found!');
                    }
                    },
                    error: function (xhr, status, error) {
                    console.error('AJAX error: ' + status + ': ' + error);
                    }
                    });

                    // Handle 'Select All' checkbox behavior
                    $('#select-all').on('click', function () {
                    var rows = table.rows({ search: 'applied' }).nodes();
                    $('input[type="checkbox"]', rows).prop('checked', this.checked);
                    });

                    // Handle individual row checkbox behavior
                    $('#userTable tbody').on('change', 'input[type="checkbox"]', function () {
                    var rowCount = $('input[type="checkbox"]:checked').length; // Get number of selected checkboxes
                    var totalRows = table.rows({ search: 'applied' }).nodes().length; // Total number of rows after search

                    var selectAll = $('#select-all').get(0);
                    if (rowCount === totalRows) {
                    selectAll.checked = true;
                    selectAll.indeterminate = false;
                    } else if (rowCount === 0) {
                    selectAll.checked = false;
                    selectAll.indeterminate = false;
                    } else {
                    selectAll.indeterminate = true;
                    }
                    });

                    // Event handler for custom length dropdown
                    $('#customLength').on('change', function () {
                    var length = $(this).val();
                    table.page.len(length).draw();
                    });

                    $(document).on('change', '#avatarUpload', function (event) {
                    var input = event.target;
                    var file = input.files[0];

                    if (file) {
                    var fileType = file.type;
                    var validImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];

                    if (!validImageTypes.includes(fileType)) {
                    Swal.fire({
                    icon: 'error',
                    title: 'Invalid File',
                    text: 'Please select a valid image (JPEG, jpg, PNG, GIF, WEBP).'
                    });
                    input.value = ''; // Reset input
                    return;
                    }

                    // File size limit (2MB)
                    //if (file.size > 2 * 1024 * 1024) {
                    // Swal.fire({
                    // icon: 'warning',
                    // title: 'File too large',
                    // text: 'Maximum allowed size is 2MB.'
                    // });
                    // input.value = ''; // Reset input
                    // return;
                    //}

                    var reader = new FileReader();
                    reader.onload = function (e) {
                    $('#userAvatar').attr('src', e.target.result);
                    };

                    reader.readAsDataURL(file);
                    }
                    });

                    // Handle 'Edit' button click event
                    $(document).on('click', '.userEdit', function () {
                    var userId = $(this).data('id');

                    $('#userAvatar').attr('src', '/assets/img/avatars/default-avatar.png');

                    // Show user ID in console for debugging
                    // console.log('Edit User ID:', userId);
                    // Load the modal content dynamically
                    $.ajax({
                    url: '/html/model_user_edit/user_edit.html', // Adjust path based on your folder structure
                    type: 'GET',
                    success: function (data) {
                    // Append the modal to the body (if not already present)
                    if ($('#editUserModal').length === 0) {
                    $('body').append(data);
                    }

                    // Set user ID in modal
                    $('#editUserModal').find('#userIdInput').val(userId);

                    // Show loading text inside the modal
                    // $('#editUserModal .modal-body').html('<p>Loading user details...</p>');

                    // Show the modal
                    $('#editUserModal').modal('show');

                    // Load user details using AJAX
                    $.ajax({
                    url: '../php/userRole/get_user_details.php', // Ensure correct path
                    type: 'POST',
                    data: { user_id: userId },
                    dataType: 'json',
                    success: function (response) {
                    if (response.success) {
                    var user = response.data;
                    // console.log('User Data:', user); // Check if data exists

                    // Populate the form with user data
                    $('#userIdInput').val(user.user_id);
                    $('#qualificationInput').val(user.qualification);
                    $('#fullNameInput').val(user.fullname);
                    $('#roleSelect').val(user.role);
                    $('#emailInput').val(user.email);
                    $('#phoneInput').val(user.phone);
                    $('#joiningDateInput').val(user.joining_date);
                    $('#statusSelect').val(user.status);
                    $('#statusCauseInput').val(user.status_change_cause);
                    $('#changeByInput').val(user.change_by);
                    $('#salaryInput').val(user.salary);
                    $('#aadharInput').val(user.aadhar_card);
                    $('#subjectInput').val(user.subject);
                    $('#userAddress').val(user.user_address);
                    $('#genderSelect').val(user.gender);
                    $('#dobDateInput').val(user.dob);
                    $('#bankNameInput').val(user.bank_name);
                    $('#branchNameInput').val(user.branch_name);
                    $('#accountNumberInput').val(user.account_number);
                    $('#ifscCodeInput').val(user.ifsc_code);
                    $('#accountType').val(user.account_type);

                    // Update user avatar
                    $('#userAvatar').attr('src', user.user_role_avatar || '/assets/img/avatars/default-avatar.png');
                    } else {
                    $('#editUserModal .modal-body').html('<p class="text-danger">User not found.</p>');
                    }
                    },
                    error: function () {
                    $('#editUserModal .modal-body').html('<p class="text-danger">Error fetching data. Please try again.</p>');
                    }
                    });
                    },
                    error: function () {
                    alert('Failed to load the edit modal.');
                    }
                    });
                    });

                    // Save user role update

                    $(document).on('click', '#saveUserChanges', function () {
                    var $this = $(this);
                    if ($this.prop('disabled')) return; // Prevent multiple clicks

                    $this
                    .html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...')
                    .prop('disabled', true);

                    // Collect form data
                    var formData = new FormData();
                    var userId = $('#userIdInput').val().trim();
                    var fullName = $('#fullNameInput').val().trim();
                    var role = $('#roleSelect').val();
                    var phone = $('#phoneInput').val().trim();
                    var joiningDate = formatDate($('#joiningDateInput').val());

                    formData.append('user_id', userId);
                    formData.append('full_name', $('#fullNameInput').val());
                    formData.append('qualification', $('#qualificationInput').val().trim());
                    formData.append('role', $('#roleSelect').val());
                    formData.append('email', $('#emailInput').val());
                    formData.append('phone', $('#phoneInput').val());
                    formData.append('dob', $('#dobDateInput').val());
                    formData.append('joining_date', $('#joiningDateInput').val());
                    formData.append('status', $('#statusSelect').val());
                    formData.append('gender', $('#genderSelect').val());
                    formData.append('salary', $('#salaryInput').val().trim());
                    formData.append('aadhar', $('#aadharInput').val().trim());
                    formData.append('subject', $('#subjectInput').val().trim());
                    formData.append('user_address', $('#userAddress').val().trim());
                    formData.append('bank_name', $('#bankNameInput').val().trim());
                    formData.append('branch_name', $('#branchNameInput').val().trim());
                    formData.append('account_number', $('#accountNumberInput').val().trim());
                    formData.append('ifsc_code', $('#ifscCodeInput').val().trim());
                    formData.append('account_type', $('#accountType').val());

                    // Handle avatar upload
                    var avatarFile = $('#avatarUpload')[0].files[0];
                    if (avatarFile) {
                    formData.append('avatar', avatarFile);
                    }

                    // Show progress bar
                    $('#uploadProgressContainer').show();
                    $('#uploadProgressBar').css('width', '0%').text('0%');

                    // console.log([...formData.entries()]); // Check what's inside the formData

                    // AJAX request to save data
                    $.ajax({
                    url: '/php/userRole/update_user_details.php',
                    type: 'POST',
                    data: formData,
                    dataType: 'json',
                    processData: false, // Required for file upload
                    contentType: false, // Required for file upload

                    xhr: function () {
                    var xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener(
                    'progress',
                    function (e) {
                    if (e.lengthComputable) {
                    var percentComplete = Math.round((e.loaded / e.total) * 100);
                    $('#uploadProgressBar')
                    .css('width', percentComplete + '%')
                    .text(percentComplete + '%');
                    }
                    },
                    false
                    );
                    return xhr;
                    },

                    success: function (response) {
                    if (response.success) {
                    alert('User details updated successfully!');

                    // Update the user avatar preview in the modal
                    if (response.avatar_path) {
                    $('#userAvatar').attr('src', response.avatar_path);
                    }

                    // Close the modal
                    $('#editUserModal').modal('hide');

                    // Find the row corresponding to the user
                    var userRow = $('#userTable tbody').find('tr[data-id="' + userId + '"]');

                    if (userRow.length > 0) {
                    userRow.find('td:nth-child(3) h6').text(fullName);
                    userRow.find('td:nth-child(4)').text(role);
                    userRow.find('td:nth-child(5)').text(phone);
                    userRow.find('td:nth-child(6)').text(joiningDate);

                    // Update avatar if changed
                    if (response.avatar_path) {
                    userRow.find('td:nth-child(3) img').attr('src', response.avatar_path);
                    }

                    // Apply smooth highlight effect
                    userRow.addClass('highlight-success');

                    setTimeout(function () {
                    userRow.addClass('fade-out');
                    setTimeout(function () {
                    userRow.removeClass('highlight-success fade-out');
                    }, 1000);
                    }, 3000);
                    } else {
                    console.warn('Row for user ID ' + userId + ' not found!');
                    }
                    } else {
                    alert('Failed to update user: ' + (response.error || 'Unknown error'));
                    }
                    },
                    error: function (xhr, status, error) {
                    console.error('AJAX Error:', status, error);
                    alert('Error updating user. Please try again.');
                    },
                    complete: function () {
                    $this.prop('disabled', false).text('Save Changes');
                    $('#uploadProgressContainer').hide(); // Hide progress bar after upload
                    }
                    });
                    });

                    // Handling Status Change (Activate, Suspend)
                    $(document).on('click', '.userActivate', function () {
                    var userId = $(this).data('id');
                    if (confirm('Are you sure you want to activate this user?')) {
                    changeStatus(userId, 'Active');
                    }
                    });

                    $(document).on('click', '.userSuspend', function () {
                    var userId = $(this).data('id');
                    if (confirm('Are you sure you want to suspend this user?')) {
                    changeStatus(userId, 'Suspended');
                    }
                    });

                    function showLoadingSpinner() {
                    $('body').append('<div class="loading-spinner">Loading...</div>');
                    }

                    function hideLoadingSpinner() {
                    $('.loading-spinner').remove();
                    }

                    /*
                    function changeStatus(userId, newStatus) {
                    showLoadingSpinner();
                    $.ajax({
                    url: '../php/userRole/update_user_status.php',
                    type: 'POST',
                    data: { user_id: userId, status: newStatus },
                    dataType: 'json', // Ensure response is parsed as JSON
                    success: function (response) {
                    hideLoadingSpinner();
                    console.log('Server Response:', response); // Debugging line

                    if (response && response.success) {
                    // Ensure response.success exists
                    Swal.fire({
                    icon: 'success',
                    title: `User status changed to ${newStatus}`,
                    toast: true,
                    timer: 2000
                    });

                    // Find the row for the updated user

                    //var row = $(`#userTable tbody tr`).filter(function () {
                    // return $(this).find('td:eq(1)').text().trim() == userId;
                    //});
                    var row = $('#userTable').find('tr[data-id="' + userId + '"]');

                    if (row.length === 0) {
                    console.error('Row not found for user ID:', userId);
                    return;
                    }

                    // Apply highlight class and ensure it sticks
                    row.addClass('highlight');

                    setTimeout(() => {
                    row.removeClass('highlight');
                    }, 5000); // Keep highlighted for 5 seconds

                    // Update the status badge
                    var statusBadge = row.find('td:eq(6) span');
                    statusBadge.removeClass('bg-label-success bg-label-secondary bg-label-warning');

                    if (newStatus === 'Active') {
                    statusBadge.addClass('bg-label-success').text(newStatus);
                    } else if (newStatus === 'Suspended') {
                    statusBadge.addClass('bg-label-secondary').text(newStatus);
                    } else if (newStatus === 'Pending') {
                    statusBadge.addClass('bg-label-warning').text(newStatus);
                    }

                    // Update dropdown menu based on the new status
                    var dropdownMenu = row.find('.dropdown-menu');
                    dropdownMenu.empty(); // Clear existing options

                    if (newStatus === 'Pending') {
                    dropdownMenu.append(
                    `
                    <a class="dropdown-item border-bottom userEdit" href="javascript:;" data-id="${userId}">Edit</a>
                    <a class="dropdown-item userActivate" href="javascript:;" data-id="${userId}">Activate</a>`
                    );
                    } else if (newStatus === 'Active') {
                    dropdownMenu.append(`
                    <a class="dropdown-item border-bottom userEdit" href="javascript:;" data-id="${userId}">Edit</a>
                    <a class="dropdown-item border-bottom userSuspend" href="javascript:;" data-id="${userId}">Suspend</a>
                    <a class="dropdown-item userCredential" href="javascript:;" data-id="${userId}">Send Credential</a>
                    `);
                    } else if (newStatus === 'Suspended') {
                    dropdownMenu.append(
                    `<a class="dropdown-item userActivate" href="javascript:;" data-id="${userId}">Activate</a>`
                    );
                    }
                    } else {
                    console.error('Response format incorrect or success=false:', response);
                    Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Failed to change status!',
                    confirmButtonText: 'OK'
                    });
                    }
                    },
                    error: function (xhr, status, error) {
                    console.error('AJAX error:', xhr.responseText);
                    Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Something went wrong. Please try again.',
                    confirmButtonText: 'OK'
                    });
                    }
                    });
                    } */

                    function changeStatus(userId, newStatus) {
                    showLoadingSpinner();

                    $.ajax({
                    url: '../php/userRole/update_user_status.php',
                    type: 'POST',
                    data: { user_id: userId, status: newStatus },
                    dataType: 'json',
                    success: function (response) {
                    hideLoadingSpinner();

                    // console.log('Server Response:', response);

                    if (response && response.success) {
                    Swal.fire({
                    icon: 'success',
                    title: `User status changed to ${newStatus}`,
                    toast: true,
                    timer: 2000
                    });

                    let table = $('#userTable').DataTable();

                    // Find row index in DataTable
                    let rowIndex = table
                    .rows()
                    .eq(0)
                    .filter(function (rowIdx) {
                    return table.cell(rowIdx, 1).data() == userId;
                    });

                    if (rowIndex.length === 0) {
                    console.error('Row not found for user ID:', userId);
                    return;
                    }

                    // Get current row data
                    let rowData = table.row(rowIndex[0]).data();

                    // ✅ Preserve the avatar & name (Assuming it's stored in column index 2)
                    let currentAvatar = rowData[2];

                    // Update status badge
                    let statusBadge = `<span class="status-badge badge ${
                      newStatus === 'Active'
                        ? 'bg-label-success'
                        : newStatus === 'Suspended'
                        ? 'bg-label-secondary'
                        : 'bg-label-warning'
                    }">${newStatus}</span>`;

                    rowData[6] = statusBadge; // Assuming status column is at index 6

                    // ✅ Keep the existing avatar & name
                    rowData[2] = currentAvatar;

                    // Update dropdown menu
                    let dropdownMenu = '';
                    if (newStatus === 'Pending') {
                    dropdownMenu = `
                    <a class="dropdown-item border-bottom userEdit" href="javascript:;" data-id="${userId}">Edit</a>
                    <a class="dropdown-item userActivate" href="javascript:;" data-id="${userId}">Activate</a>`;
                    } else if (newStatus === 'Active') {
                    dropdownMenu = `
                    <a class="dropdown-item border-bottom userEdit" href="javascript:;" data-id="${userId}">Edit</a>
                    <a class="dropdown-item border-bottom userSuspend" href="javascript:;" data-id="${userId}">Suspend</a>
                    <a class="dropdown-item userCredential" href="javascript:;" data-id="${userId}">Send Credential</a>`;
                    } else if (newStatus === 'Suspended') {
                    dropdownMenu = `<a class="dropdown-item userActivate" href="javascript:;" data-id="${userId}">Activate</a>`;
                    }

                    rowData[7] = `
                    <a href="javascript:;" class="tf-icons bx bx-show bx-sm me-2 text-info userView" data-id="${userId}"
                      title="View User"></a>
                    <a href="javascript:;" class="tf-icons bx bx-trash bx-sm me-2 text-danger userDelete" data-id="${userId}"
                      title="Delete User"></a>
                    <a href="javascript:;" class="tf-icons bx bx-dots-vertical-rounded bx-sm text-warning"
                      data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="More Options"></a>
                    <div class="dropdown-menu dropdown-menu-end">${dropdownMenu}</div>
                    `;

                    // Update row in DataTable
                    table.row(rowIndex[0]).data(rowData).draw(false);

                    // Reinitialize Bootstrap dropdown (🔥 FIXES action menu issue)
                    setTimeout(() => {
                    $('[data-bs-toggle="dropdown"]').dropdown();
                    }, 100);

                    // Highlight row
                    /*
                    let row = $(`#userTable tbody tr[data-id="${userId}"]`);
                    row.addClass('highlight');
                    setTimeout(() => row.removeClass('highlight'), 5000);*/

                    // ✅ Highlight row
                    let rowNode = table.row(rowIndex[0]).node();
                    $(rowNode).addClass('highlighted-row');

                    // ✅ Remove highlight after 5 seconds
                    setTimeout(() => $(rowNode).removeClass('highlighted-row'), 5000);
                    } else {
                    console.error('Response format incorrect or success=false:', response);
                    Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Failed to change status!',
                    confirmButtonText: 'OK'
                    });
                    }
                    },
                    error: function (xhr, status, error) {
                    console.error('AJAX error:', xhr.responseText);
                    Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Something went wrong. Please try again.',
                    confirmButtonText: 'OK'
                    });
                    }
                    });
                    }

                    // Handel 'ViewButton' click event
                    $(document).on('click', '.userView', function () {
                    var userId = $(this).data('id');
                    alert('View user profile:' + userId);
                    });



                    // Handle 'Credential send' button click event
                    $(document).on('click', '.userCredential', function () {
                    var userId = $(this).data('id');

                    // AJAX request to fetch user credentials from the server
                    $.ajax({
                    url: '/php/whatsapp/getUserCredentials.php', // Backend script to fetch credentials
                    type: 'POST',
                    data: { user_id: userId }, // Send the user ID to the backend
                    dataType: 'json', // Expect JSON response
                    success: function (response) {
                    if (response.success) {
                    var fullName = response.data.fullname;
                    var password = response.data.password;
                    var phone = response.data.phone;
                    var fromName = response.data.fromName;

                    // Display confirmation before sending credentials
                    if (confirm('Send credentials to:\n' + 'Full Name: ' + fullName + '\n' + 'Phone: ' + phone)) {
                    // Send credentials via WhatsApp API
                    $.ajax({
                    url: '/php/whatsapp/sendUserRoleCred.php', // Script to send via WhatsApp
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                    fullName: fullName,
                    user_id: userId,
                    password: password,
                    phone: phone,
                    fromName: fromName
                    }),
                    success: function (sendResponse) {
                    console.log('Success:', sendResponse);
                    alert('Credentials sent successfully!');
                    },
                    error: function (xhr) {
                    console.error('Error:', xhr.responseText);
                    alert('Failed to send credentials.');
                    }
                    });
                    }
                    } else {
                    alert('User credentials not found.');
                    }
                    },
                    error: function (xhr) {
                    console.error('Error fetching credentials:', xhr.responseText);
                    alert('Error retrieving user credentials.');
                    }
                    });
                    });

                    // Handle bulk action for changing status will use later
                    /*
                    $('#applyBulkAction').click(function () {
                    var action = $('#bulkAction').val();
                    var selectedUsers = [];
                    $('.row-select:checked').each(function () {
                    selectedUsers.push($(this).data('id'));
                    });

                    if (selectedUsers.length > 0 && action) {
                    selectedUsers.forEach(function (userId) {
                    changeStatus(userId, action);
                    });
                    } else {
                    alert('Please select users and an action');
                    }
                    }); */

                    // Handle Delete function
                    $(document).on('click', '.userDelete', function () {
                    var userId = $(this).data('id'); // Get the user ID
                    var row = $(this).closest('tr'); // Get the table row containing the delete button

                    // Show confirmation popup using SweetAlert2
                    Swal.fire({
                    title: 'You will not be able to revert this! ',
                    text: 'Are you sure want to delete the user : ' + userId + '?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                    }).then(result => {
                    if (result.isConfirmed) {
                    // Show Swal loading while processing
                    Swal.fire({
                    title: 'Deleting...',
                    text: 'Please wait',
                    icon: 'info',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => {
                    Swal.showLoading();
                    }
                    });

                    $.ajax({
                    url: '../php/userRole/delete_user.php', // PHP script to handle deletion
                    type: 'POST',
                    data: { user_id: userId },
                    dataType: 'json',
                    success: function (response) {
                    if (response.success) {
                    // Show success message
                    Swal.fire({
                    title: 'Deleted!',
                    text: 'User ' + userId + ' has been deleted.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                    });

                    // Remove the row dynamically from DataTable
                    var table = $('#userTable').DataTable();
                    table.row(row).remove().draw();
                    } else {
                    Swal.fire('Error!', response.message, 'error');
                    }
                    },
                    error: function (xhr, status, error) {
                    console.error('AJAX Error:', status, error);
                    Swal.fire('Error!', 'An error occurred while deleting.', 'error');
                    }
                    });
                    }
                    });
                    });

                    // Handle print button click event
                    $('#printBtn').on('click', function () {
                    table.button('.buttons-print').trigger(); // Trigger print when clicked
                    });

                    // Ensure the print button is only visible if the print button is configured
                    if ($('.buttons-print').length) {
                    $('#printBtn').show(); // Show the print button if it's available
                    } else {
                    $('#printBtn').hide(); // Hide the print button if not available
                    }

                    //search box
                    $('#searchBox').on('keyup', function () {
                    table.search(this.value).draw();
                    });
                    });

*********************************
$.ajax({
url: '../php/userRole/update_user_status.php',
type: 'POST',
data: { user_id: userId, status: newStatus },
dataType: 'json',
success: function (response) {
hideLoadingSpinner();

// console.log('Server Response:', response);

if (response && response.success) {
Swal.fire({
icon: 'success',
title: `User status changed to ${newStatus}`,
toast: true,
timer: 2000
});

let table = $('#userTable').DataTable();

// Find row index in DataTable
let rowIndex = table
.rows()
.eq(0)
.filter(function (rowIdx) {
return table.cell(rowIdx, 1).data() == userId;
});

if (rowIndex.length === 0) {
console.error('Row not found for user ID:', userId);
return;
}

// Get current row data
let rowData = table.row(rowIndex[0]).data();

// ✅ Preserve the avatar & name (Assuming it's stored in column index 2)
let currentAvatar = rowData[2];

// Update status badge
let statusBadge = `<span class="status-badge badge ${
            newStatus === 'Active'
              ? 'bg-label-success'
              : newStatus === 'Suspended'
              ? 'bg-label-secondary'
              : 'bg-label-warning'
          }">${newStatus}</span>`;

rowData[6] = statusBadge; // Assuming status column is at index 6

// ✅ Keep the existing avatar & name
rowData[2] = currentAvatar;

// Update dropdown menu
let dropdownMenu = '';
if (newStatus === 'Pending') {
dropdownMenu = `
<a class="dropdown-item border-bottom userEdit" href="javascript:;" data-id="${userId}">Edit</a>
<a class="dropdown-item userActivate" href="javascript:;" data-id="${userId}">Activate</a>`;
} else if (newStatus === 'Active') {
dropdownMenu = `
<a class="dropdown-item border-bottom userEdit" href="javascript:;" data-id="${userId}">Edit</a>
<a class="dropdown-item border-bottom userSuspend" href="javascript:;" data-id="${userId}">Suspend</a>
<a class="dropdown-item userCredential" href="javascript:;" data-id="${userId}">Send Credential</a>`;
} else if (newStatus === 'Suspended') {
dropdownMenu = `<a class="dropdown-item userActivate" href="javascript:;" data-id="${userId}">Activate</a>`;
}

rowData[7] = `
<a href="javascript:;" class="tf-icons bx bx-show bx-sm me-2 text-info userView" data-id="${userId}"
  title="View User"></a>
<a href="javascript:;" class="tf-icons bx bx-trash bx-sm me-2 text-danger userDelete" data-id="${userId}"
  title="Delete User"></a>
<a href="javascript:;" class="tf-icons bx bx-dots-vertical-rounded bx-sm text-warning" data-bs-toggle="dropdown"
  aria-haspopup="true" aria-expanded="false" title="More Options"></a>
<div class="dropdown-menu dropdown-menu-end">${dropdownMenu}</div>
`;

// Update row in DataTable
table.row(rowIndex[0]).data(rowData).draw(false);

// Reinitialize Bootstrap dropdown (🔥 FIXES action menu issue)
setTimeout(() => {
$('[data-bs-toggle="dropdown"]').dropdown();
}, 100);

// Highlight row
/*
let row = $(`#userTable tbody tr[data-id="${userId}"]`);
row.addClass('highlight');
setTimeout(() => row.removeClass('highlight'), 5000);*/

// ✅ Highlight row
let rowNode = table.row(rowIndex[0]).node();
$(rowNode).addClass('highlighted-row');

// ✅ Remove highlight after 5 seconds
setTimeout(() => $(rowNode).removeClass('highlighted-row'), 5000);
} else {
console.error('Response format incorrect or success=false:', response);
Swal.fire({
icon: 'error',
title: 'Oops...',
text: 'Failed to change status!',
confirmButtonText: 'OK'
});
}
},
error: function (xhr, status, error) {
console.error('AJAX error:', xhr.responseText);
Swal.fire({
icon: 'error',
title: 'Oops...',
text: 'Something went wrong. Please try again.',
confirmButtonText: 'OK'
});
}
});
}
