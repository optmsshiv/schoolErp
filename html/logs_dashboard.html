<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Logs Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">

    <h2 class="text-center">ðŸ“Š WhatsApp Message Logs</h2>
    <table class="table table-bordered table-striped mt-4">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Phone</th>
                <th>Full Name</th>
                <th>User ID</th>
                <th>Status</th>
                <th>Response</th>
                <th>Timestamp</th>
            </tr>
        </thead>
        <tbody id="logsTable">
            <tr><td colspan="7" class="text-center">Loading logs...</td></tr>
        </tbody>
    </table>

    <!-- Response Modal -->
    <div class="modal fade" id="responseModal" tabindex="-1" aria-labelledby="responseModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="responseModalLabel">API Response</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <!-- Search Bar -->
          <div class="p-2">
            <input type="text" id="searchInput" class="form-control" placeholder="ðŸ” Search in response..."
              onkeyup="searchResponse()">
          </div>

          <div class="modal-body">
            <button class="btn btn-sm btn-secondary mb-2" onclick="toggleExpand()">ðŸ”½ Expand/Collapse</button>
            <pre id="responseContent" class="p-3 bg-dark text-light rounded border"
              style="max-height: 400px; overflow: auto;"></pre>
          </div>

          <div class="modal-footer">
            <button class="btn btn-outline-primary" onclick="copyResponse()">ðŸ“‹ Copy</button>
            <button class="btn btn-outline-success" onclick="downloadResponse()">â¬‡ Download</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>


    <script>
        function fetchLogs() {
            fetch('/php/whatsapp/whatsapp_logs.php')
                .then(response => response.json())
                .then(data => {
                    const logsTable = document.getElementById('logsTable');
                    logsTable.innerHTML = '';

                    if (data.success && data.logs.length > 0) {
                        data.logs.forEach(log => {
                            const statusColor = log.message_status === 'sent' ? 'text-success' : 'text-danger';
                            logsTable.innerHTML += `
                                <tr>
                                    <td>${log.id}</td>
                                    <td>${log.phone}</td>
                                    <td>${log.fullname}</td>
                                    <td>${log.userId}</td>
                                    <td class="${statusColor}">${log.message_status}</td>
                                    <td><button class="btn btn-sm btn-info" data-response='${JSON.stringify(log.response)}' onclick="showResponse(this)">View</button></td>
                                    <td>${log.created_at}</td>
                                </tr>`;
                        });
                    } else {
                        logsTable.innerHTML = '<tr><td colspan="7" class="text-center">No logs found</td></tr>';
                    }
                })
                .catch(error => console.error('Error fetching logs:', error));
        }

        function highlightJSON(json) {
            return json.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
              .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = "text-light";
                if (/^"/.test(match)) {
                  cls = /:$/.test(match) ? "text-warning" : "text-success"; // Keys and strings
                } else if (/true|false/.test(match)) {
                  cls = "text-primary"; // Boolean
                } else if (/null/.test(match)) {
                  cls = "text-danger"; // Null
                } else {
                  cls = "text-info"; // Numbers
                }
                return `<span class="${cls}">${match}</span>`;
              });
          }


          function copyResponse() {
              let text = document.getElementById('responseContent').innerText;
              navigator.clipboard.writeText(text).then(() => {
                let copyButton = document.querySelector('.btn-outline-primary');
                copyButton.innerText = "âœ… Copied!";
                setTimeout(() => copyButton.innerText = "ðŸ“‹ Copy", 2000);
              }).catch(err => {
                console.error("Failed to copy:", err);
              });
            }


            function downloadResponse() {
                let text = document.getElementById('responseContent').innerText;
                let blob = new Blob([text], { type: "application/json" });
                let link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "whatsapp_api_response.json";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
              }




              let originalResponse = ""; // Store original response for search feature
        function showResponse(button) {
            let response = button.getAttribute('data-response');

            try {
              let parsedResponse = JSON.parse(response);
              originalResponse = JSON.stringify(parsedResponse, null, 2); // Store original response

              // Display formatted JSON with syntax highlighting
              document.getElementById('responseContent').innerHTML = `<code>${highlightJSON(originalResponse)}</code>`;

              new bootstrap.Modal(document.getElementById('responseModal')).show();
            } catch (error) {
              console.error("Invalid JSON:", response);
              document.getElementById('responseContent').innerHTML = "<span class='text-danger'>Invalid response data.</span>";
              new bootstrap.Modal(document.getElementById('responseModal')).show();
            }
          }

          // toggle large JSON responses for better visibility
          let expanded = false;

            function toggleExpand() {
              let responseContent = document.getElementById('responseContent');
              if (expanded) {
                responseContent.style.maxHeight = "400px";
                responseContent.style.overflow = "auto";
              } else {
                responseContent.style.maxHeight = "none";
                responseContent.style.overflow = "visible";
              }
              expanded = !expanded;
            }

            // quickly find specific data
            function searchResponse() {
                let searchInput = document.getElementById('searchInput').value.toLowerCase();
                let highlightedResponse = originalResponse.replace(new RegExp(searchInput, "gi"), match => {
                  return `<mark class="bg-warning text-dark">${match}</mark>`;
                });

                document.getElementById('responseContent').innerHTML = `<code>${highlightJSON(highlightedResponse)}</code>`;
              }




        fetchLogs();
        setInterval(fetchLogs, 30000); // Refresh logs every 30 seconds
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>
