<!DOCTYPE html>
<html lang="en" class="light-style layout-menu-fixed layout-compact" dir="ltr" data-theme="theme-default"
      data-assets-path="../assets/" data-template="Dashboard">

<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

  <title>Dashboard - School Management ERP | School ERP - Dashboard</title>

  <meta name="description" content="" />
  <title>WhatsApp Logs Dashboard</title>


  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
    rel="stylesheet" />

  <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />

  <!-- Core CSS -->
  <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
  <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />

  <!-- Vendors CSS -->
  <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
  <link rel="stylesheet" href="../assets/vendor/libs/apex-charts/apex-charts.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

  <!-- Page CSS -->

  <!-- Helpers -->
  <script src="../assets/vendor/js/helpers.js"></script>
  <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
  <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
  <script src="../assets/js/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <style>
    .table-responsive {
      max-height: 500px;
      overflow-y: auto;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #0b85fe;
      color: white;
      z-index: 2;
    }
  </style>

</head>

<body class="layout-navbar-fixed">

<div class="layout-wrapper layout-content-navbar">
  <div class="layout-container">

    <!-- Menu -->
    <div id="menu"></div>
    <!-- / Menu -->

    <!-- Layout container -->
    <div class="layout-page">
      <!-- Navbar -->

      <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center"
           id="layout-navbar">
        <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
          <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
            <i class="bx bx-menu bx-sm"></i>
          </a>
        </div>

        <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
          <!-- Search -->
          <div class="navbar-nav align-items-center">
            <div class="nav-item d-flex align-items-center">
              <i class="bx bx-search fs-4 lh-0"></i>
              <input type="text" class="form-control border-0 shadow-none ps-1 ps-sm-2" placeholder="Search..."
                     aria-label="Search..." />
            </div>
          </div>
          <!-- /Search -->

          <ul class="navbar-nav flex-row align-items-center ms-auto">
            <!-- Place this tag where you want the button to render. -->

            <a class="mode">
                <span class="position-relative moon-sun">
                  <i class="bx bx-moon bx-sm icon moon"></i>
                  <i class="bx bx-sun bx-sm icon sun"></i>
                  <a class="toggle-switch"> <span class="switch"></span></a>
                </span>
            </a>

            <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown"
               data-bs-auto-close="outside" aria-expanded="false">
                <span class="position-relative">
                  <i class="bx bx-table bx-sm"></i>
                  <span class="badge rounded-pill bg-danger badge-dot badge-notifications border"></span>
                </span>
            </a>

            <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown"
               data-bs-auto-close="outside" aria-expanded="false">
                <span class="position-relative">
                  <i class="bx bx-bell bx-sm"></i>
                  <span class="badge rounded-pill bg-danger badge-dot badge-notifications border"></span>
                </span>
            </a>

            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#">Notification 1</a></li>
              <li><a class="dropdown-item" href="#">See all notifications</a></li>
            </ul>

            <!-- User -->
            <li class="nav-item navbar-dropdown dropdown-user dropdown">
              <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                <div class="avatar avatar-online">
                  <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                </div>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="#">
                    <div class="d-flex">
                      <div class="flex-shrink-0 me-3">
                        <div class="avatar avatar-online">
                          <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                        </div>
                      </div>
                      <div class="flex-grow-1">
                        <span class="fw-medium d-block">John Doe</span>
                        <small class="text-muted">Admin</small>
                      </div>
                    </div>
                  </a>
                </li>
                <li>
                  <div class="dropdown-divider"></div>
                </li>
                <li>
                  <a class="dropdown-item" href="#">
                    <i class="bx bx-user me-2"></i>
                    <span class="align-middle">My Profile</span>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">
                    <i class="bx bx-cog me-2"></i>
                    <span class="align-middle">Settings</span>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">
                      <span class="d-flex align-items-center align-middle">
                        <i class="flex-shrink-0 bx bx-credit-card me-2"></i>
                        <span class="flex-grow-1 align-middle ms-1">Billing</span>
                        <span class="flex-shrink-0 badge badge-center rounded-pill bg-danger w-px-20 h-px-20">4</span>
                      </span>
                  </a>
                </li>
                <li>
                  <div class="dropdown-divider"></div>
                </li>
                <li>
                  <a class="dropdown-item" href="javascript:void(0);">
                    <i class="bx bx-power-off me-2"></i>
                    <span class="align-middle" onclick="location.href='../html/login.html'">Log Out</span>
                  </a>
                </li>
              </ul>
            </li>
            <!--/ User -->
          </ul>
        </div>
      </nav>

      <!-- / Navbar -->

      <!-- Content wrapper -->
      <div class="content-wrapper">
        <div class="container-xxl flex-grow-1 container-p-y">
          <h2 class="text-center">üìä WhatsApp Message Logs</h2>
          <div class="d-flex justify-content-between mb-3">
            <button class="btn btn-outline-primary" onclick="fetchLogs()">üîÑ Refresh Logs</button>
            <div>
              <label class="me-2">Auto-Refresh:</label>
              <input type="checkbox" id="autoRefreshToggle" checked onchange="toggleAutoRefresh()">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <label>üìÖ From Date:</label>
              <input type="date" id="fromDate" class="form-control">
            </div>
            <div class="col-md-4">
              <label>üìÖ To Date:</label>
              <input type="date" id="toDate" class="form-control">
            </div>
            <div class="col-md-4">
              <label>üìû Phone Number:</label>
              <input type="text" id="phoneFilter" class="form-control" placeholder="Enter phone">
            </div>
          </div>

          <div class="mb-3">
            <button class="btn btn-success" onclick="fetchLogs()">üîç Apply Filter</button>
            <button class="btn btn-outline-success ms-2" onclick="exportLogs('csv')">üì§ Export CSV</button>
            <button class="btn btn-outline-info ms-2" onclick="exportLogs('excel')">üì• Export Excel</button>
          </div>

          <div id="alertBox" class="alert d-none mb-3" role="alert"></div>

          <div class="table-responsive">
            <table class="table table-bordered mt-4">
              <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Phone</th>
                <th>Full Name</th>
                <th>User ID</th>
                <th>Status</th>
                <th>Response</th>
                <th>Actions</th>
                <th>Timestamp</th>
              </tr>
              </thead>
              <tbody id="logsTable">
              <tr>
                <td colspan="8" class="text-center">Loading logs...</td>
              </tr>
              </tbody>
            </table>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <canvas id="messageStatsChart" width="400" height="200"></canvas>
            </div>
          </div>


          <!-- Response Modal -->
          <div class="modal fade" id="responseModal" tabindex="-1" aria-labelledby="responseModalLabel"
               aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="responseModalLabel">API Response</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Search Bar -->
                <div class="p-2">
                  <input type="text" id="searchInput" class="form-control" placeholder="üîç Search in response..."
                         onkeyup="searchResponse()">
                </div>

                <div class="modal-body">
                  <button class="btn btn-sm btn-secondary mb-2" onclick="toggleExpand()">üîΩ Expand/Collapse</button>
                  <pre id="responseContent" class="p-3 bg-warning text-light rounded border"
                       style="max-height: 400px; overflow: auto;"></pre>
                </div>

                <div class="modal-footer">
                  <button class="btn btn-primary" onclick="copyResponse()">üìã Copy</button>
                  <button class="btn btn-outline-success" onclick="downloadResponse()">‚¨á Download</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>

        </div>


        <!-- / Content -->

        <!-- Footer -->
        <footer class="content-footer footer bg-footer-theme">
          <div class="container-xxl d-flex flex-wrap justify-content-between py-2 flex-md-row flex-column">
            <div class="mb-2 mb-md-0">
              ¬©
              <script>
                document.write(new Date().getFullYear())
              </script>
              , made with ‚ù§Ô∏è by
              <a href="https://optms.co.in" target="_blank" class="footer-link fw-medium">OPTMS Tech</a>
            </div>
            <div class="d-none d-lg-inline-block">
              <a href="https://www.optms.co.in/" target="_blank" class="footer-link me-4">Connect</a>
              <a href="https://www.optms.co.in/issues" target="_blank" class="footer-link">Support</a>
            </div>
          </div>
        </footer>
        <!-- / Footer -->

        <div class="content-backdrop fade"></div>
      </div>
      <!-- Content wrapper -->

      <!-- / Layout page -->

      <!-- Overlay -->
      <div class="layout-overlay layout-menu-toggle"></div>
    </div>
    <!-- / Layout wrapper -->
  </div>
</div>

<!-- Core JS -->
<!-- build:js assets/vendor/js/core.js -->

<script src="../assets/vendor/libs/jquery/jquery.js"></script>
<script src="../assets/vendor/libs/popper/popper.js"></script>
<script src="../assets/vendor/js/bootstrap.js"></script>
<script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
<script src="../assets/vendor/js/menu.js"></script>

<!-------------------------------Chart js---------------------------------->
<script type="text/javascript" src="/model/collectionChart.js"></script>
<script src="../model/chart.js"></script>
<!--eChart js-->

<!-- end build -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
<!-- end build-->

<!-- Vendors JS -->
<script src="../assets/vendor/libs/apex-charts/apexcharts.js"></script>

<!-- Main JS -->
<script src="../assets/js/main.js"></script>

<!-- Page JS -->
<script src="../assets/js/dashboards-analytics.js"></script>

<!---total calculate card js-->
<script src="../custome js/card_count/total_student_card.js"></script>

<!-- Menu load script -->
<script src="/menu/menuScript.js"></script>

<script>
  let originalResponse = "" // Store original response for search feature
  let messageChart

  function updateChart(logs) {
    let successCount = logs.filter(log => log.message_status === "success").length
    let failedCount = logs.length - successCount

    let ctx = document.getElementById("messageStatsChart").getContext("2d")

    if (messageChart) {
      messageChart.destroy()
    }

    messageChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["Success", "Failed"],
        datasets: [{
          data: [successCount, failedCount],
          backgroundColor: ["#28a745", "#dc3545"]
        }]
      }
    })
  }

  // Fetch logs with optional filters
  function fetchLogs() {
    let fromDate = document.getElementById("fromDate").value
    let toDate = document.getElementById("toDate").value
    let phoneFilter = document.getElementById("phoneFilter").value

    let url = `/php/whatsapp/whatsapp_logs.php?from=${fromDate}&to=${toDate}&phone=${phoneFilter}`

    fetch(url)
      .then(response => response.json())
      .then(data => {
        const logsTable = document.getElementById("logsTable")
        logsTable.innerHTML = ""
        updateLogsTable(data)
        updateChart(data.logs)
        checkForFailedMessages(data.logs)
      })
      .catch(error => console.error("Error fetching logs:", error))
  }

  let pinnedLogs = JSON.parse(localStorage.getItem("pinnedLogs")) || []

  function pinLog(logId) {
    logId = String(logId) // Ensure logId is treated as a string

    // Toggle pin status
    if (!pinnedLogs.includes(logId)) {
      pinnedLogs.push(logId)
    } else {
      pinnedLogs = pinnedLogs.filter(id => id !== logId)
    }
    // Save to localStorage and refresh the logs
    localStorage.setItem("pinnedLogs", JSON.stringify(pinnedLogs))

    // Find the row and change its background color immediately
    let row = document.getElementById(`logRow-${logId}`)
    if (row) {
      if (pinnedLogs.includes(logId)) {
        row.style.backgroundColor = "#fff3cd" // Highlight pinned log
      } else {
        row.style.backgroundColor = "" // Reset background if unpinned
      }
    }
    fetchLogs()
  }

  // Update the logs table with data
  function updateLogsTable(data) {
    let logsTable = document.getElementById("logsTable")
    logsTable.innerHTML = ""

    // Separate pinned logs and regular logs
    let pinned = data.logs.filter(log => pinnedLogs.includes(String(log.id)))
    let regular = data.logs.filter(log => !pinnedLogs.includes(String(log.id)))

    // Concatenate pinned logs first, followed by regular logs
    let sortedLogs = [...pinned, ...regular]

    // Render each log in the table
    sortedLogs.forEach(log => {
      const statusColor = log.message_status === "success" ? "text-success" : "text-danger"
      logsTable.innerHTML += `
            <tr id="logRow-${log.id}" ${pinnedLogs.includes(String(log.id)) ? "style=\"background-color: #eefc4e;\"" : ""}>
                <td>${log.id}</td>
                <td>${log.phone}</td>
                <td>${log.fullname}</td>
                <td>${log.userId}</td>
                <td class="${statusColor}">${log.message_status}</td>
                <td><button class="btn btn-sm btn-info" data-response='${JSON.stringify(log.response)}' onclick="showResponse(this)">View</button></td>
                <td><button class="btn btn-warning btn-sm" onclick="pinLog('${log.id}')">üìå Pin</button></td>
                <td>${log.created_at}</td>
            </tr>`
    })

    // If no logs found, show a message
    if (data.success && data.logs.length === 0) {
      logsTable.innerHTML = "<tr><td colspan=\"8\" class=\"text-center\">No logs found</td></tr>"
    }
  }

  // Check for failed messages and display alert
  function checkForFailedMessages(logs) {
    let failedMessages = logs.filter(log => log.message_status !== "success")
    let alertBox = document.getElementById("alertBox")

    if (failedMessages.length > 0) {
      alertBox.className = "alert alert-danger"
      alertBox.innerHTML = `‚ö† ${failedMessages.length} messages failed! Check logs.`
      alertBox.classList.remove("d-none")
    } else {
      alertBox.classList.add("d-none")
    }
  }

  // Highlight JSON for better readability
  function highlightJSON(json) {
    return json.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
      .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function(match) {
        let cls = "text-light"
        if (/^"/.test(match)) {
          cls = /:$/.test(match) ? "text-warning" : "text-success" // Keys and strings
        } else if (/true|false/.test(match)) {
          cls = "text-primary" // Boolean
        } else if (/null/.test(match)) {
          cls = "text-danger" // Null
        } else {
          cls = "text-info" // Numbers
        }
        return `<span class="${cls}">${match}</span>`
      })
  }

  // Export logs as CSV or Excel
  function exportLogs(format) {
    let tableData = document.getElementById("logsTable").innerHTML
    let blob = new Blob([tableData], { type: format === "csv" ? "text/csv" : "application/vnd.ms-excel" })
    let link = document.createElement("a")
    link.href = URL.createObjectURL(blob)
    link.download = `whatsapp_logs.${format}`
    link.click()
  }

  // Copy response to clipboard
  function copyResponse() {
    let text = document.getElementById("responseContent").innerText
    navigator.clipboard.writeText(text).then(() => {
      let copyButton = document.querySelector(".btn-primary")
      copyButton.innerText = "‚úÖ Copied!"
      setTimeout(() => copyButton.innerText = "üìã Copy", 2000)
    }).catch(err => {
      console.error("Failed to copy:", err)
    })
  }

  // Download response as JSON file
  function downloadResponse() {
    let text = document.getElementById("responseContent").innerText
    let blob = new Blob([text], { type: "application/json" })
    let link = document.createElement("a")
    link.href = URL.createObjectURL(blob)
    link.download = "whatsapp_api_response.json"
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
  }

  // Show the formatted response in a modal
  function showResponse(button) {
    let response = button.getAttribute("data-response")
    try {
      let parsedResponse = JSON.parse(response)
      originalResponse = JSON.stringify(parsedResponse, null, 2) // Store original response

      // Display formatted JSON with syntax highlighting
      document.getElementById("responseContent").innerHTML = `<code>${highlightJSON(originalResponse)}</code>`

      new bootstrap.Modal(document.getElementById("responseModal")).show()
    } catch (error) {
      console.error("Invalid JSON:", response)
      document.getElementById("responseContent").innerHTML = "<span class='text-danger'>Invalid response data.</span>"
      new bootstrap.Modal(document.getElementById("responseModal")).show()
    }
  }

  // Toggle large JSON responses for better visibility
  let expanded = false

  function toggleExpand() {
    let responseContent = document.getElementById("responseContent")
    if (expanded) {
      responseContent.style.maxHeight = "400px"
      responseContent.style.overflow = "auto"
    } else {
      responseContent.style.maxHeight = "none"
      responseContent.style.overflow = "visible"
    }
    expanded = !expanded
  }

  // Quickly find specific data in response
  function searchResponse() {
    let searchInput = document.getElementById("searchInput").value.toLowerCase()
    let highlightedResponse = originalResponse.replace(new RegExp(searchInput, "gi"), match => {
      return `<mark class="bg-warning text-dark">${match}</mark>`
    })

    document.getElementById("responseContent").innerHTML = `<code>${highlightJSON(highlightedResponse)}</code>`
  }

  // Auto refresh logs
  let autoRefresh = true
  let refreshInterval

  function toggleAutoRefresh() {
    autoRefresh = document.getElementById("autoRefreshToggle").checked
    if (autoRefresh) {
      refreshInterval = setInterval(fetchLogs, 30000)
    } else {
      clearInterval(refreshInterval)
    }
  }

  // Initial fetch and auto refresh setup
  fetchLogs()
  setInterval(fetchLogs, 30000)

</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</body>

</html>
